<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title class="pjax-title">Rust製のパーサコンビネータnom v6.0.0を解剖する - drumato.com</title><meta name="Description" content=""><meta property="og:title" content="Rust製のパーサコンビネータnom v6.0.0を解剖する" />
<meta property="og:description" content="この記事は IPFactory Advent Calendar 2020 の1日目です． IPFactoryという技術サークルについては 余談 を御覧ください． 普段コンパイラ自作をしていて，LLパーサを" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://drumato.com/ja/posts/dive-into-nom/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-12-01T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-12-01T00:00:00+00:00" /><meta property="og:site_name" content="drumato.com" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Rust製のパーサコンビネータnom v6.0.0を解剖する"/>
<meta name="twitter:description" content="この記事は IPFactory Advent Calendar 2020 の1日目です． IPFactoryという技術サークルについては 余談 を御覧ください． 普段コンパイラ自作をしていて，LLパーサを"/>
<meta name="application-name" content="drumato.com">
<meta name="apple-mobile-web-app-title" content="drumato.com">

<meta name="theme-color" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="http://drumato.com/ja/posts/dive-into-nom/" /><link rel="prev" href="http://drumato.com/ja/posts/tuipeach/" /><link rel="next" href="http://drumato.com/ja/posts/dive-into-combine/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/fontawesome-free/all.min.css">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/animate/animate.min.css">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Rust製のパーサコンビネータnom v6.0.0を解剖する",
        "inLanguage": "ja",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/drumato.com\/ja\/posts\/dive-into-nom\/"
        },"genre": "posts","keywords": "parser-combinator, code-reading, nom, rust","wordcount":  6263 ,
        "url": "http:\/\/drumato.com\/ja\/posts\/dive-into-nom\/","datePublished": "2020-12-01T00:00:00+00:00","dateModified": "2020-12-01T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": "Drumato"},"author": {
                "@type": "Person",
                "name": "Drumato"
            },"description": ""
    }
    </script></head>

<body header-desktop="" header-mobile=""><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme); document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark');}
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' || theme === 'black' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('' === 'light' || '' === 'dark' || '' === 'black') setTheme(''), saveTheme(''); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627','black': '#000000'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/ja/" title="drumato.com"><span id="desktop-header-typeit" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/ja/about/"> About </a><a class="menu-item" href="/ja/posts/"> 記事一覧 </a><a class="menu-item" href="/ja/diaries/"> 日記一覧 </a><a class="menu-item" href="/ja/thissite/"> このサイトについて </a><span class="menu-item delimiter"></span><a href="#" onclick="return false;" class="menu-item language" title="Select Language">Japanese<i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" title="Select Language" id="language-select-desktop" onchange="location = this.value;"><option value="/ja/posts/dive-into-nom/" selected>Japanese</option></select>
                    </a><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="#" onclick="return false;" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" onclick="return false;" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="#" onclick="return false;" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/ja/" title="drumato.com"><span id="mobile-header-typeit" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="#" onclick="return false;" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" onclick="return false;" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="#" onclick="return false;" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/ja/about/" title="">About</a><a class="menu-item" href="/ja/posts/" title="">記事一覧</a><a class="menu-item" href="/ja/diaries/" title="">日記一覧</a><a class="menu-item" href="/ja/thissite/" title="">このサイトについて</a><a href="#" onclick="return false;" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a><a href="#" onclick="return false;" class="menu-item" title="Select Language">Japanese<i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" title="Select Language" onchange="location = this.value;"><option value="/ja/posts/dive-into-nom/" selected>Japanese</option></select>
                </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><div class="toc" id="toc-auto">
        <h2 class="toc-title">Contents</h2>
        <div class="toc-content" id="toc-content-auto"><nav id="TableOfContents">
  <ul>
    <li><a href="#前提-nomとは">前提: nomとは</a>
      <ul>
        <li><a href="#サンプル">サンプル</a></li>
      </ul>
    </li>
    <li><a href="#nomを解剖する3ステップ">nomを解剖する3ステップ</a>
      <ul>
        <li><a href="#nomiresulti-o-e"><code>nom::IResult&lt;I, O, E&gt;</code></a></li>
        <li><a href="#パーサ関数とトレイト境界">パーサ関数とトレイト境界</a></li>
      </ul>
    </li>
    <li><a href="#nomのモジュールパーサ紹介">nomのモジュール，パーサ紹介</a>
      <ul>
        <li><a href="#nombytescompletetag"><code>nom::bytes::complete::tag</code></a></li>
        <li><a href="#nomcharactercompletesatisfy"><code>nom::character::complete::satisfy</code></a></li>
      </ul>
    </li>
    <li><a href="#まとめ">まとめ</a></li>
    <li><a href="#余談-ipfactoryについて">余談: IPFactoryについて</a></li>
    <li><a href="#余談2-nombranchalt-について">余談2: <code>nom::branch::alt</code> について</a></li>
  </ul>
</nav></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle", "normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Rust製のパーサコンビネータnom v6.0.0を解剖する</h1><div class="post-meta">
            <div class="post-meta-line">
                <span class="post-author"><i class="author fas fa-user-circle fa-fw"></i><a href="/ja/" title="Author" rel=" author" class="author">Drumato</a>
                </span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2020-12-01">2020-12-01</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime="2020-12-01">2020-12-01</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;6263 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;13 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#前提-nomとは">前提: nomとは</a>
      <ul>
        <li><a href="#サンプル">サンプル</a></li>
      </ul>
    </li>
    <li><a href="#nomを解剖する3ステップ">nomを解剖する3ステップ</a>
      <ul>
        <li><a href="#nomiresulti-o-e"><code>nom::IResult&lt;I, O, E&gt;</code></a></li>
        <li><a href="#パーサ関数とトレイト境界">パーサ関数とトレイト境界</a></li>
      </ul>
    </li>
    <li><a href="#nomのモジュールパーサ紹介">nomのモジュール，パーサ紹介</a>
      <ul>
        <li><a href="#nombytescompletetag"><code>nom::bytes::complete::tag</code></a></li>
        <li><a href="#nomcharactercompletesatisfy"><code>nom::character::complete::satisfy</code></a></li>
      </ul>
    </li>
    <li><a href="#まとめ">まとめ</a></li>
    <li><a href="#余談-ipfactoryについて">余談: IPFactoryについて</a></li>
    <li><a href="#余談2-nombranchalt-について">余談2: <code>nom::branch::alt</code> について</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>この記事は <a href="https://qiita.com/advent-calendar/2020/ipfactory" target="_blank" rel="noopener noreferrer">IPFactory Advent Calendar 2020</a> の1日目です．<br>
IPFactoryという技術サークルについては <a href="#%e4%bd%99%e8%ab%87-IPFactory%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6" rel="">余談</a> を御覧ください．</p>
<p>普段コンパイラ自作をしていて，LLパーサを手書きすることが多い私ですが，<br>
｢そういえばパーサライブラリ使ったことないな｣と思い，現在 <a href="https://github.com/Drumato/peachili" target="_blank" rel="noopener noreferrer">自作コンパイラプロジェクト</a> のパーサを書き換えています．<br>
そこで使っているのが， <a href="https://github.com/Geal/nom" target="_blank" rel="noopener noreferrer">Geal/nom</a> というパーサコンビネータのライブラリです．</p>
<p>Rustの強力な型システムの上でジェネリックなパーサ関数を実装しているということで，<br>
きっと様々なRustのエッセンスが含まれていると思い，コードリーディングしようと感じました．<br>
また，いずれパーサライブラリも自作したいなと思っているので，<br>
その前段階として既存実装を調べる必要があると思いました．</p>
<p>Rustのパーサライブラリとしてもう一つ有名なものに <a href="https://github.com/Marwes/combine" target="_blank" rel="noopener noreferrer">Marwes/combine</a> がありますが，<br>
これも記事上げようかなーなんて考えています．<br>
IPFカレンダーにあげようかなー，他メンバーの記事で埋まらなかったら上がるのでお楽しみに．</p>
<p>今回はv6.0.0を対象とします．<br>
<del>投稿前日に見返したら6.0.1がリリースされていたけど気にしない</del></p>
<h2 id="前提-nomとは" class="headerLink">
    <a href="#%e5%89%8d%e6%8f%90-nom%e3%81%a8%e3%81%af" class="header-mark"></a>1 前提: nomとは</h2><p>nom内部の解説を前に，nom自体の解説をしておきます．<br>
<a href="https://github.com/Geal/nom/blob/master/README.md" target="_blank" rel="noopener noreferrer">README.md</a>を読むと，次のように書いてあります．</p>
<blockquote>
<p>nomはRustで書かれたパーサコンビネータのライブラリです．<br>
nomは速度やメモリ消費を犠牲にすることなく安全なパーサを構築することを支援します．<br>
高速で正確なパーサを実現するために，Rustの強力な型システムやメモリ安全性を活用しています．<br>
バグを生みやすい&quot;パイプライン&quot;を抽象化するための関数やマクロ，トレイトなども提供しています．</p>
</blockquote>
<p>実際の設計は後述しますが，<br>
nomの設計はコンパイル時に決まるような <strong>&ldquo;静的ディスパッチ&rdquo;</strong> の集合で実現されています．<br>
(実行時に型を解決する&quot;動的ディスパッチ&quot;ではなく)<br>
パーサコンビネータを使用するときにパーサ同士を連携させる部分のバグが起こりやすい，みたいな話なのでしょうか．<br>
確かに暗黙的で動的な型システムの上で動かそうと思ったらヒヤヒヤしてしまいますね．</p>
<h3 id="サンプル" class="headerLink">
    <a href="#%e3%82%b5%e3%83%b3%e3%83%97%e3%83%ab" class="header-mark"></a>1.1 サンプル</h3><p><a href="https://github.com/Geal/nom/blob/master/README.md" target="_blank" rel="noopener noreferrer">README.md</a>に記載のサンプルを見てみます．<br>
コメントで簡単に解説を加えているので，参考にしてください．</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">extern</span><span class="w"> </span><span class="k">crate</span><span class="w"> </span><span class="n">nom</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">nom</span>::<span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">IResult</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">bytes</span>::<span class="n">complete</span>::<span class="p">{</span><span class="n">tag</span><span class="p">,</span><span class="w"> </span><span class="n">take_while_m_n</span><span class="p">},</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">combinator</span>::<span class="n">map_res</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">sequence</span>::<span class="n">tuple</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#[derive(Debug,PartialEq)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Color</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">pub</span><span class="w"> </span><span class="n">red</span>:   <span class="kt">u8</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">pub</span><span class="w"> </span><span class="n">green</span>: <span class="kt">u8</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">pub</span><span class="w"> </span><span class="n">blue</span>:  <span class="kt">u8</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">from_hex</span><span class="p">(</span><span class="n">input</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">std</span>::<span class="n">num</span>::<span class="n">ParseIntError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="kt">u8</span>::<span class="n">from_str_radix</span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">is_hex_digit</span><span class="p">(</span><span class="n">c</span>: <span class="kt">char</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">c</span><span class="p">.</span><span class="n">is_digit</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">hex_primary</span><span class="p">(</span><span class="n">input</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">IResult</span><span class="o">&lt;&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="kt">u8</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// take_while_m_n(min, max, condition) は，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">  </span><span class="c1">// 入力列の各要素に対しconditionを適用し，それがtrueを返した回数が[min..max]に含まれるかどうか判別する．
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">  </span><span class="c1">// map_res(parser, f) は，parserの返す値に関数fを適用して返す．
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">  </span><span class="c1">// 今回はtake_while_m_nが二桁の16進数(の文字列)を返すはずなので，それに対してfrom_hexを適用し，u8型を返すという感じ．
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">  </span><span class="n">map_res</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">take_while_m_n</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">is_hex_digit</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">from_hex</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">)(</span><span class="n">input</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">hex_color</span><span class="p">(</span><span class="n">input</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">IResult</span><span class="o">&lt;&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">Color</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// tag() はシンプルに引数のパターンと合致するかチェック．
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">  </span><span class="c1">// カラーコードにおいて &#34;#&#34; は意味を持たないので，パーサの成果物は捨ててしまう．
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tag</span><span class="p">(</span><span class="s">&#34;#&#34;</span><span class="p">)(</span><span class="n">input</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// tupleは関数に渡したタプル内のパーサを順次適用して，その結果をタプルに格納して返す．  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">  </span><span class="c1">// カラーコードは先頭から順にRGBとなっているため，その数値をパターン代入で受け取り，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">  </span><span class="c1">// Color構造体を構築して返す，ということをしている．
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">red</span><span class="p">,</span><span class="w"> </span><span class="n">green</span><span class="p">,</span><span class="w"> </span><span class="n">blue</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tuple</span><span class="p">((</span><span class="n">hex_primary</span><span class="p">,</span><span class="w"> </span><span class="n">hex_primary</span><span class="p">,</span><span class="w"> </span><span class="n">hex_primary</span><span class="p">))(</span><span class="n">input</span><span class="p">)</span><span class="o">?</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nb">Ok</span><span class="p">((</span><span class="n">input</span><span class="p">,</span><span class="w"> </span><span class="n">Color</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">red</span><span class="p">,</span><span class="w"> </span><span class="n">green</span><span class="p">,</span><span class="w"> </span><span class="n">blue</span><span class="w"> </span><span class="p">}))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#[test]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">parse_color</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// パース関数の返り値チェック
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">  </span><span class="c1">// hex_color のシグネチャを見ると分かる通り，返り値はResultになっている．
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">  </span><span class="c1">// タプルの第一要素には&#34;パース成功後のeatされた文字列&#34;が，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">  </span><span class="c1">// 第二要素には&#34;パース関数が成功した時に返す成果物&#34;が格納されている．
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">  </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">hex_color</span><span class="p">(</span><span class="s">&#34;#2F14DF&#34;</span><span class="p">),</span><span class="w"> </span><span class="nb">Ok</span><span class="p">((</span><span class="s">&#34;&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">Color</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">red</span>: <span class="mi">47</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">green</span>: <span class="mi">20</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">blue</span>: <span class="mi">223</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">})));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><h2 id="nomを解剖する3ステップ" class="headerLink">
    <a href="#nom%e3%82%92%e8%a7%a3%e5%89%96%e3%81%99%e3%82%8b3%e3%82%b9%e3%83%86%e3%83%83%e3%83%97" class="header-mark"></a>2 nomを解剖する3ステップ</h2><p>nomのパーサ定義は次のような手順で読みすすめるとシンプルに理解できます．</p>
<ul>
<li>nomのパーサ関数のほとんどは <code>nom::IResult&lt;I, O, E&gt;</code> を返す</li>
<li>パーサ関数が受け取る型はnomが定義するトレイトのいくつかを実装している必要がある
<ul>
<li><code>nom::bytes</code> や <code>nom::character</code> はこれらトレイト境界を利用して制約付きジェネリクスを実現している</li>
<li>例えば <code>nom::bytes</code> はバイトストリームを扱う関数群が定義するが，引数にはバイトストリームの振る舞いを定義したトレイト境界を設けている</li>
</ul>
</li>
<li>パーサ関数の実装は，これらトレイトが持つ関数を組み合わせて実現している</li>
</ul>
<h3 id="nomiresulti-o-e" class="headerLink">
    <a href="#nomiresulti-o-e" class="header-mark"></a>2.1 <code>nom::IResult&lt;I, O, E&gt;</code></h3><p>まずは基本的な型から見ていきましょう．<br>
nomでは殆どすべてのパーサ関数が <a href="https://docs.rs/nom/6.0.0/nom/type.IResult.html" target="_blank" rel="noopener noreferrer"><code>IResult</code></a> という型を返すようになっています．</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">type</span> <span class="nc">IResult</span><span class="o">&lt;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Error</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">(</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">O</span><span class="p">),</span><span class="w"> </span><span class="nb">Err</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;&gt;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p><code>I</code> は <em>Input</em> を表し，パーサ関数に入力するパース対象の型を示します．<br>
<code>O</code> は <em>Output</em> を表し，パース成功時に返す型を示します．<br>
パーサは <strong>パース成功後のeatされた文字列</strong> を返すので，<br>
<code>Result::Ok</code> には <code>(eatされた文字列, パース成功時に生成される成果物の型)</code> という値の組が入ります．</p>
<p>コンパイラのコードでは <code>fn integer_literal(i: &amp;str) -&gt; nom::IResult&lt;&amp;str, ast::Node&gt;</code> のように，<br>
パース結果をASTノードにすることが多いです．</p>
<p>ここで <code>Error</code> は <code>std::error::Error</code> ではなく <code>nom::error::Error</code> であり， <code>Err</code> は <code>nom::Err</code> です．</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="cp">#[derive(Debug, PartialEq)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Error</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="sd">/// position of the error in the input data
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="w">  </span><span class="k">pub</span><span class="w"> </span><span class="n">input</span>: <span class="nc">I</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="sd">/// nom error code
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="w">  </span><span class="k">pub</span><span class="w"> </span><span class="n">code</span>: <span class="nc">ErrorKind</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">ErrorKind</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">Tag</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">MapRes</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">MapOpt</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// stripped
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nb">Err</span><span class="o">&lt;</span><span class="n">E</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">Incomplete</span><span class="p">(</span><span class="n">Needed</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">Error</span><span class="p">(</span><span class="n">E</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">Failure</span><span class="p">(</span><span class="n">E</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">Needed</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">Unknown</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">Size</span><span class="p">(</span><span class="n">NonZeroUsize</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>まず，nomのパーサが返す可能性のあるエラーは</p>
<ul>
<li><code>Incomplete</code> &hellip; パースが完了しなかった</li>
<li><code>Error</code> &hellip; 回復可能なエラー</li>
<li><code>Failure</code> &hellip; 回復不可能なエラー</li>
</ul>
<p>の三種類です．<br>
それぞれがどのような場面で使われるのかについては後述します．<br>
デフォルトでは <code>nom::IResult&lt;I, O, E = Error&lt;I&gt;&gt;</code> となっているので， <code>IResult&lt;&amp;str, ast::Node&gt;</code> とすると <code>Error.input: &amp;str</code>  のようになります．<br>
<code>nom::Err</code> は <code>std::error::Error</code> を実装しているので，<br>
<code>Result&lt;T, Box&lt;dyn std::error::Error&gt;&gt;</code> のような関数内で <code>?</code> 演算子を使用することも可能です．</p>
<h3 id="パーサ関数とトレイト境界" class="headerLink">
    <a href="#%e3%83%91%e3%83%bc%e3%82%b5%e9%96%a2%e6%95%b0%e3%81%a8%e3%83%88%e3%83%ac%e3%82%a4%e3%83%88%e5%a2%83%e7%95%8c" class="header-mark"></a>2.2 パーサ関数とトレイト境界</h3><p>先程 <code>nom::IResult&lt;I, O, E&gt;</code> について紹介しましたが，<br>
パーサ関数内での <code>I</code> は，<a href="https://github.com/Geal/nom/blob/6.0.0/src/traits.rs" target="_blank" rel="noopener noreferrer"><code>traits.rs</code></a> に記載されているトレイト群(のいくつか)を実装していることを強制します．<br>
nomでは <code>&amp;str</code> や <code>&amp;[u8]</code> など，これらのトレイトが既に実装済みの型を使うこともできますが，<br>
ユーザが自身で定義した型にこれらトレイトを実装することで任意の型が扱えるようになっています．</p>
<p>実際に一つパーサ関数を見てみましょう．<br>
<a href="https://docs.rs/nom/6.0.0/nom/bytes/complete/fn.is_a.html" target="_blank" rel="noopener noreferrer"><code>nom::bytes::complete::is_a</code></a> という，<br>
パターンに適合する先頭部分文字列をeatして返す関数を例にあげます．</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">is_a</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Input</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span>: <span class="nc">ParseError</span><span class="o">&lt;</span><span class="n">Input</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">arr</span>: <span class="nc">T</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="n">Input</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">IResult</span><span class="o">&lt;</span><span class="n">Input</span><span class="p">,</span><span class="w"> </span><span class="n">Input</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">where</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">Input</span>: <span class="nc">InputTakeAtPosition</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">T</span>: <span class="nc">FindToken</span><span class="o">&lt;&lt;</span><span class="n">Input</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">InputTakeAtPosition</span><span class="o">&gt;</span>::<span class="n">Item</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">move</span><span class="w"> </span><span class="o">|</span><span class="n">i</span>: <span class="nc">Input</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">e</span>: <span class="nc">ErrorKind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ErrorKind</span>::<span class="n">IsA</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">i</span><span class="p">.</span><span class="n">split_at_position1_complete</span><span class="p">(</span><span class="o">|</span><span class="n">c</span><span class="o">|</span><span class="w"> </span><span class="o">!</span><span class="n">arr</span><span class="p">.</span><span class="n">find_token</span><span class="p">(</span><span class="n">c</span><span class="p">),</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>まず取り上げるべきなのは， <code>T: FindToken&lt;&lt;Input as InputTakeAtPosition&gt;::Item&gt;</code> という構文です．<br>
これは <strong>Fully Qualified Syntax</strong> というもので，<br>
今回の例で言えば，</p>
<ul>
<li><code>Input</code> 型が実装する <code>InputTakeAtPosition</code> トレイト</li>
<li>その関連型である <code>Item</code> をパラメータとして渡した <code>FindToken</code> トレイト</li>
<li>それを実装する 型 <code>T</code></li>
</ul>
<p>という意味です．<br>
Fully Qualified Syntaxについては<a href="https://doc.rust-lang.org/book/ch19-03-advanced-traits.html#fully-qualified-syntax-for-disambiguation-calling-methods-with-the-same-name" target="_blank" rel="noopener noreferrer">こちらのサンプル</a>も合わせてご覧ください．</p>
<p>例えば <code>Input = &amp;str</code> とします．<br>
<a href="https://github.com/Geal/nom/blob/master/src/traits.rs#L760" target="_blank" rel="noopener noreferrer"><code>impl&lt;'a&gt; InputTakeAtPosition for &amp;'a str</code></a> を見ると，<br>
<code>type Item = char;</code> と宣言されています．<br>
また，<a href="https://github.com/Geal/nom/blob/master/src/traits.rs#L1119" target="_blank" rel="noopener noreferrer"><code>impl&lt;'a&gt; FindToken&lt;char&gt; for &amp;'a str</code></a> が実装されているので，<br>
この関数に <code>&amp;str</code> を渡すことができるとわかります．<br>
つまり， <strong>&quot;<code>&amp;str</code> 型のパーサを書くとき，<code>is_a</code> の引数に指定するパターンも <code>&amp;str</code> でかけるよ&quot;</strong> という意味になるのです．</p>
<p>返り値はクロージャですが，クロージャを返す関数では <code>impl trait</code> 型を指定するのが一般的です(<a href="https://doc.rust-lang.org/rust-by-example/fn/closures/output_parameters.html" target="_blank" rel="noopener noreferrer">Rust by Example</a> を参照)．<br>
Rustにおけるクロージャについては<a href="https://keens.github.io/blog/2016/10/10/rustnokuro_ja3tanewotsukutterikaisuru/" target="_blank" rel="noopener noreferrer">こちらの記事</a>がとてもわかりやすいです．</p>
<p><a href="https://github.com/Geal/nom/blob/master/src/traits.rs#L801" target="_blank" rel="noopener noreferrer">トレイト定義</a>を見るとわかりますが，<br>
第一引数に指定した <code>P: Fn(Self::Item) -&gt; bool</code> を <a href="https://doc.rust-lang.org/std/primitive.str.html#method.find" target="_blank" rel="noopener noreferrer"><code>str::find</code></a> に渡し，<br>
<code>Some(i) if i != 0</code> ならばパース成功とする，というようなイメージです．</p>
<p>追うのが中々大変だと思うので，まずは <code>Input = &amp;str, Item = char</code> に限定した実装を用意しました．<br>
下記サンプルは<a href="https://github.com/Drumato/blog_samples/tree/main/dive_into_nom/special_is_a" target="_blank" rel="noopener noreferrer">GitHub</a>にも置いてあります．</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="sd">/// 適当なエラー型
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="cp">#[derive(Debug)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">enum</span> <span class="nc">Error</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Failed</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="sd">/// impl FindToken&lt;char&gt; for &amp;strの簡易実装
</span></span></span><span class="line"><span class="cl"><span class="sd">/// 単にnomの実装の中身を持ってきただけ
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="k">fn</span> <span class="nf">find_char</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="n">arr</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">c</span>: <span class="kt">char</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">arr</span><span class="p">.</span><span class="n">chars</span><span class="p">().</span><span class="n">any</span><span class="p">(</span><span class="o">|</span><span class="n">i</span><span class="o">|</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="sd">/// impl InputTokenAtPosition for &amp;str の簡易実装
</span></span></span><span class="line"><span class="cl"><span class="sd">/// これも実際の中身を取り出した
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="k">fn</span> <span class="nf">split_at_position1_complete</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="n">P</span><span class="o">&gt;</span><span class="p">(</span><span class="n">s</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">predicate</span>: <span class="nc">P</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(</span><span class="o">&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="kt">str</span><span class="p">),</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">where</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">P</span>: <span class="nb">Fn</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">predicate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">Error</span>::<span class="n">Failed</span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Ok</span><span class="p">((</span><span class="o">&amp;</span><span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="o">..</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">s</span><span class="p">[</span><span class="o">..</span><span class="n">i</span><span class="p">])),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nb">Err</span><span class="p">(</span><span class="n">Error</span>::<span class="n">Failed</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="nb">Ok</span><span class="p">((</span><span class="o">&amp;</span><span class="n">s</span><span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="o">..</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="n">s</span><span class="p">[</span><span class="o">..</span><span class="n">s</span><span class="p">.</span><span class="n">len</span><span class="p">()]))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="sd">/// nom::bytes::complete::is_a の実装ほぼそのまま
</span></span></span><span class="line"><span class="cl"><span class="sd"></span><span class="k">fn</span> <span class="nf">specialized_is_a</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="p">(</span><span class="n">arr</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span> <span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="o">&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(</span><span class="o">&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="kt">str</span><span class="p">),</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">move</span><span class="w"> </span><span class="o">|</span><span class="n">i</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="o">|</span><span class="w"> </span><span class="n">split_at_position1_complete</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">c</span><span class="o">|</span><span class="w"> </span><span class="o">!</span><span class="n">find_char</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">digit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">specialized_is_a</span><span class="p">(</span><span class="s">&#34;1234567890&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">eprintln!</span><span class="p">(</span><span class="s">&#34;is_a(\&#34;1234567890\&#34;)(\&#34;123abc\&#34;) =&gt; {:?}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">digit</span><span class="p">(</span><span class="s">&#34;123abc&#34;</span><span class="p">));</span><span class="w"> </span><span class="c1">//=&gt; is_a(&#34;1234567890&#34;)(&#34;123abc&#34;) =&gt; Ok((&#34;abc&#34;, &#34;123&#34;))
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">eprintln!</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="s">&#34;is_a(\&#34;1234567890\&#34;)(\&#34;Drumato\&#34;) =&gt; {:?}&#34;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">digit</span><span class="p">(</span><span class="s">&#34;Drumato&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">);</span><span class="w"> </span><span class="c1">//=&gt; is_a(&#34;1234567890&#34;)(&#34;Drumato&#34;) =&gt; Err(Failed)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">eprintln!</span><span class="p">(</span><span class="s">&#34;is_a(\&#34;1234567890\&#34;)(\&#34;\&#34;) =&gt; {:?}&#34;</span><span class="p">,</span><span class="w"> </span><span class="n">digit</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">));</span><span class="w"> </span><span class="c1">//=&gt; is_a(&#34;1234567890&#34;)(&#34;&#34;) =&gt; Err(Failed)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>これだけであれば，文字列操作で実現された単なる(関数を返す)関数です．<br>
これを <strong>Rustの強力な静的ディスパッチ</strong> によって汎用的にし,<br>
<code>specialized_is_a</code> の引数や，返すクロージャの引数や返り値をジェネリクスによって実現したものがnomというわけです．</p>
<p>かなり複雑な型パズルになっているので初見は分かりづらいかもしれませんが，<br>
これらは全てコンパイル時に決定し <code>Box&lt;dyn trait&gt;</code> 等の動的ディスパッチによるコストもない，非常にキレイな設計になっていると言えます．</p>
<p>ここまでで，nomのパーサを読む前提知識が身につきました．</p>
<ul>
<li>パーサの殆どは <code>IResult&lt;I, O, E = Error&lt;I&gt;&gt; = Result&lt;(I, O), Err&lt;E&gt;&gt;</code> という型を返す</li>
<li>パーサ関数はnomが定義するトレイトを用いて制約付きジェネリクスを実現している
<ul>
<li><code>&amp;[u8]</code> や <code>&amp;str</code> 等の関してはデフォルト実装が存在し，すぐに使い始められる</li>
<li>それ以外の型にトレイトを実装することで，任意の型をパーサ関数に入力できる</li>
</ul>
</li>
<li>パーサ関数は各トレイトに定義された振る舞いの関数を組み合わせて実現されている
<ul>
<li>例えば <code>nom::bytes::complete::is_a</code> は <code>FindToken::find_token</code> や <code>InputTakeAtPosition::split_at_position1_complete</code> など</li>
</ul>
</li>
</ul>
<h2 id="nomのモジュールパーサ紹介" class="headerLink">
    <a href="#nom%e3%81%ae%e3%83%a2%e3%82%b8%e3%83%a5%e3%83%bc%e3%83%ab%e3%83%91%e3%83%bc%e3%82%b5%e7%b4%b9%e4%bb%8b" class="header-mark"></a>3 nomのモジュール，パーサ紹介</h2><p>nomは以下のモジュールを公開しています．</p>
<table>
<thead>
<tr>
<th style="text-align:center">モジュール名</th>
<th style="text-align:center">説明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>nom::bits</code></td>
<td style="text-align:center">ビットレベルのパーサ</td>
</tr>
<tr>
<td style="text-align:center"><code>nom::bytes</code></td>
<td style="text-align:center">バイトストリームのパーサ</td>
</tr>
<tr>
<td style="text-align:center"><code>nom::character</code></td>
<td style="text-align:center"><code>char</code> 単位のパーサ</td>
</tr>
<tr>
<td style="text-align:center"><code>nom::combinator</code></td>
<td style="text-align:center">パーサコンビネータ群</td>
</tr>
<tr>
<td style="text-align:center"><code>nom::error</code></td>
<td style="text-align:center">nomのエラー管理</td>
</tr>
<tr>
<td style="text-align:center"><code>nom::multi</code></td>
<td style="text-align:center">パーサを引数に受け取って，複数回適用したりみたいなことに使う</td>
</tr>
<tr>
<td style="text-align:center"><code>nom::number</code></td>
<td style="text-align:center">数値関連のパーサ</td>
</tr>
<tr>
<td style="text-align:center"><code>nom::regexp</code></td>
<td style="text-align:center">正規表現を用いたパーサ定義</td>
</tr>
<tr>
<td style="text-align:center"><code>nom:sequence</code></td>
<td style="text-align:center"><code>(a, b, c)</code>など，シーケンス構造のパーサ</td>
</tr>
</tbody>
</table>
<p>これらの関数をすべて紹介していたら大変なことになっていますので，<br>
いくつか取り上げて実装を見てみる，ということをやってみましょう．</p>
<h3 id="nombytescompletetag" class="headerLink">
    <a href="#nombytescompletetag" class="header-mark"></a>3.1 <code>nom::bytes::complete::tag</code></h3><p>以下のようにして使うことができる，シンプルなパターンマッチングのパーサです．<br>
下記サンプルコードは<a href="https://github.com/Drumato/blog_samples/blob/main/dive_into_nom/bytes_tag/src/main.rs" target="_blank" rel="noopener noreferrer">GitHub</a> にもおいてあります．</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">fn</span> <span class="nf">elf_magic_number</span><span class="p">(</span><span class="n">i</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nc">nom</span>::<span class="n">IResult</span><span class="o">&lt;&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">]</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">nom</span>::<span class="n">bytes</span>::<span class="n">complete</span>::<span class="n">tag</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="mh">0x7f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x45</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x46</span><span class="p">])(</span><span class="n">i</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">drumato</span><span class="p">(</span><span class="n">i</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">nom</span>::<span class="n">IResult</span><span class="o">&lt;&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="kt">str</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">nom</span>::<span class="n">bytes</span>::<span class="n">complete</span>::<span class="n">tag</span><span class="p">(</span><span class="s">&#34;drumato&#34;</span><span class="p">)(</span><span class="n">i</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#[test]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">drumato_test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="nb">Ok</span><span class="p">((</span><span class="s">&#34;;&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;drumato&#34;</span><span class="p">)),</span><span class="w"> </span><span class="n">drumato</span><span class="p">(</span><span class="s">&#34;drumato;&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">drumato</span><span class="p">(</span><span class="s">&#34;not_drumato;&#34;</span><span class="p">).</span><span class="n">is_err</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#[test]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">elf_magic_number_test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nb">Ok</span><span class="p">((</span><span class="o">&amp;</span><span class="p">[</span><span class="mh">0x00</span><span class="p">][</span><span class="o">..</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="p">[</span><span class="mh">0x7f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x45</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x46</span><span class="p">][</span><span class="o">..</span><span class="p">])),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">elf_magic_number</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="mh">0x7f</span><span class="p">,</span><span class="w"> </span><span class="mh">0x45</span><span class="p">,</span><span class="w"> </span><span class="mh">0x4c</span><span class="p">,</span><span class="w"> </span><span class="mh">0x46</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">])</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">elf_magic_number</span><span class="p">(</span><span class="o">&amp;</span><span class="p">[</span><span class="mh">0x01</span><span class="p">,</span><span class="w"> </span><span class="mh">0x02</span><span class="p">,</span><span class="w"> </span><span class="mh">0x03</span><span class="p">,</span><span class="w"> </span><span class="mh">0x04</span><span class="p">,</span><span class="w"> </span><span class="mh">0x05</span><span class="p">]).</span><span class="n">is_err</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>ELFバイナリのパーサもバイトストリームパーサを構築することで実装できますし，<br>
<code>&amp;str</code> のような型も勿論使うことが出来ます．<br>
今回はELFバイナリのマジックナンバーをパースする関数を作っています．</p>
<p>非常にシンプルな関数なので，その実装も直感的です．<br>
<a href="https://docs.rs/nom/6.0.0/src/nom/bytes/complete.rs.html#33" target="_blank" rel="noopener noreferrer">実際の定義</a> を見てみます．</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">tag</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">Input</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span>: <span class="nc">ParseError</span><span class="o">&lt;</span><span class="n">Input</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">tag</span>: <span class="nc">T</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="n">Input</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">IResult</span><span class="o">&lt;</span><span class="n">Input</span><span class="p">,</span><span class="w"> </span><span class="n">Input</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">where</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">Input</span>: <span class="nc">InputTake</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Compare</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">T</span>: <span class="nc">InputLength</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Clone</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">move</span><span class="w"> </span><span class="o">|</span><span class="n">i</span>: <span class="nc">Input</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">tag_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tag</span><span class="p">.</span><span class="n">input_len</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tag</span><span class="p">.</span><span class="n">clone</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span>: <span class="nc">IResult</span><span class="o">&lt;</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">compare</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">CompareResult</span>::<span class="nb">Ok</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">take_split</span><span class="p">(</span><span class="n">tag_len</span><span class="p">)),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">e</span>: <span class="nc">ErrorKind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ErrorKind</span>::<span class="n">Tag</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nb">Err</span><span class="p">(</span><span class="nb">Err</span>::<span class="n">Error</span><span class="p">(</span><span class="n">Error</span>::<span class="n">from_error_kind</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">)))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">};</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">res</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><ul>
<li>入力文字列とパターン <code>tag</code> を比較して，成功すればパターンの長さで分割して返す
<ul>
<li>後述しますが， <code>take_split()</code> はある一点で区切って，<strong>&ldquo;区切りより前の列&rdquo;</strong> をタプルの第一引数にして返すので注意です</li>
<li><code>&quot;Drumato&quot;.take_split(4) =&gt; (&quot;ato&quot;, &quot;Drum&quot;)</code> という感じ</li>
<li>これはまさに序盤で説明した <code>(eatされた文字列, パーサ関数の成果物)</code> という構成．</li>
</ul>
</li>
<li>失敗すれば，適切に <code>ErrorKind</code> を設定して返します．
<ul>
<li><code>Err(Err::Error(Error::from_error_kind(i, e)))</code> と非常に分かりづらくなっています</li>
<li>冗長に書くと <code>Result::Err(nom::Err::Error(nom::error::Error::from_error_kind(i, e)))</code> となる</li>
</ul>
</li>
</ul>
<p>先程<a href="https://docs.rs/nom/6.0.0/nom/bytes/complete/fn.is_a.html" target="_blank" rel="noopener noreferrer"><code>nom::bytes::complete::is_a</code></a>を見たのと同じように，<br>
クロージャを返す関数になっています．<br>
先程詳しくは説明しませんでしたが，引数の型 <code>T</code> はあくまでマッチを判断するパターンのために使われます．<br>
パーサに入力される型は <code>Input</code> であり， <code>T</code> と同じではない点に注意してください．</p>
<p>ここでは <code>T == Input == &amp;str</code> と限定して，<br>
この関数を読むために必要な部分を持ってきました．<br>
といっても，メソッド名からある程度予想ができますが．</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="c1">// Tに必要な実装
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">impl</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">InputLength</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="kt">str</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="cp">#[inline]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">fn</span> <span class="nf">input_len</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">usize</span> <span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// Inputに必要な実装
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">impl</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="n">InputTake</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="kt">str</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="cp">#[inline]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">fn</span> <span class="nf">take</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">count</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* stripped */</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">// return byte index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">  </span><span class="cp">#[inline]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">fn</span> <span class="nf">take_split</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">count</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="p">(</span><span class="bp">Self</span><span class="p">,</span><span class="w"> </span><span class="bp">Self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">[</span><span class="n">count</span><span class="o">..</span><span class="p">],</span><span class="w"> </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">[</span><span class="o">..</span><span class="n">count</span><span class="p">])</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">// Inputに必要な実装
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">impl</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="p">,</span><span class="w"> </span><span class="o">&#39;</span><span class="na">b</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Compare</span><span class="o">&lt;&amp;&#39;</span><span class="na">b</span><span class="w"> </span><span class="kt">str</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="o">&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="kt">str</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="cp">#[inline(always)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">fn</span> <span class="nf">compare</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">t</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">b</span> <span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">CompareResult</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">().</span><span class="n">compare</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="cp">#[inline(always)]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">fn</span> <span class="nf">compare_no_case</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">t</span>: <span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">b</span> <span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">CompareResult</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* stripped */</span><span class="w"> </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>これだけ見ると素朴な実装に見えますね．<br>
実際にはこれらがコンパイル時にガチャガチャと組み合わされて実現されます．<br>
なんだか魔法のように見えますが，これこそRustの実現する型システムの恩恵，という感じがしますよね．</p>
<h3 id="nomcharactercompletesatisfy" class="headerLink">
    <a href="#nomcharactercompletesatisfy" class="header-mark"></a>3.2 <code>nom::character::complete::satisfy</code></h3><p><code>satisfy</code> に渡した関数 <code>fn(char) -&gt; bool</code> が真を返す場合，その文字をパースして返すという関数です．<br>
これ単体で用いることは少なく，以下のように他のパーサ関数と組み合わせて使う事が多いです．</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">use</span><span class="w"> </span><span class="n">nom</span>::<span class="n">character</span>::<span class="n">complete</span>::<span class="n">satisfy</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">nom</span>::<span class="n">combinator</span>::<span class="n">map</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">use</span><span class="w"> </span><span class="n">nom</span>::<span class="n">multi</span>::<span class="n">many1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">bin</span><span class="p">(</span><span class="n">i</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">nom</span>::<span class="n">IResult</span><span class="o">&lt;&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">map</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">many1</span><span class="p">(</span><span class="n">satisfy</span><span class="p">(</span><span class="o">|</span><span class="n">c</span><span class="o">|</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;0&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;1&#39;</span><span class="p">)),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="o">|</span><span class="n">chars</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;|</span><span class="w"> </span><span class="n">chars</span><span class="p">.</span><span class="n">into_iter</span><span class="p">().</span><span class="n">collect</span><span class="p">(),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)(</span><span class="n">i</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="cp">#[test]</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">fn</span> <span class="nf">bin_test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="nb">Ok</span><span class="p">((</span><span class="s">&#34;&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;0&#34;</span><span class="p">.</span><span class="n">to_string</span><span class="p">())),</span><span class="w"> </span><span class="n">bin</span><span class="p">(</span><span class="s">&#34;0&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="nb">Ok</span><span class="p">((</span><span class="s">&#34;&#34;</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;11010&#34;</span><span class="p">.</span><span class="n">to_string</span><span class="p">())),</span><span class="w"> </span><span class="n">bin</span><span class="p">(</span><span class="s">&#34;11010&#34;</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">bin</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">).</span><span class="n">is_err</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p>これも <a href="https://github.com/Geal/nom/blob/da6d9a13682d7e8245b992598903f28df4a531e1/src/character/complete.rs#L57" target="_blank" rel="noopener noreferrer">実際の定義</a>を見てみましょう．</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">satisfy</span><span class="o">&lt;</span><span class="n">F</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span>: <span class="nc">ParseError</span><span class="o">&lt;</span><span class="n">I</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">cond</span>: <span class="nc">F</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="nb">Fn</span><span class="p">(</span><span class="n">I</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">IResult</span><span class="o">&lt;</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">where</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">I</span>: <span class="nc">Slice</span><span class="o">&lt;</span><span class="n">RangeFrom</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">InputIter</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">&lt;</span><span class="n">I</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">InputIter</span><span class="o">&gt;</span>::<span class="n">Item</span>: <span class="nc">AsChar</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="n">F</span>: <span class="nb">Fn</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">move</span><span class="w"> </span><span class="o">|</span><span class="n">i</span>: <span class="nc">I</span><span class="o">|</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">iter_elements</span><span class="p">().</span><span class="n">next</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">t</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">as_char</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cond</span><span class="p">(</span><span class="n">c</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">})</span><span class="w"> </span><span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nb">Some</span><span class="p">((</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">))</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Ok</span><span class="p">((</span><span class="n">i</span><span class="p">.</span><span class="n">slice</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="o">..</span><span class="p">),</span><span class="w"> </span><span class="n">c</span><span class="p">)),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="nb">Err</span>::<span class="n">Error</span><span class="p">(</span><span class="n">Error</span>::<span class="n">from_error_kind</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">ErrorKind</span>::<span class="n">Satisfy</span><span class="p">))),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="p">}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">}</span><span class="w">
</span></span></span></code></pre></div><p><code>InputIter::next()</code> が返す，シーケンスの最初の要素に対して <code>cond</code> を適用し，<br>
その返り値が真であった場合のみパース成功としています．<br>
非常にシンプルで分かりやすい実装なので特に取り上げることもありませんが，<br>
<code>iter_elements()</code> で返ってくるのはイテレータそのものという点に注意です．<br>
<code>&amp;str</code> であれば <code>chars()</code> を呼び出しています．</p>
<h2 id="まとめ" class="headerLink">
    <a href="#%e3%81%be%e3%81%a8%e3%82%81" class="header-mark"></a>4 まとめ</h2><p>今回はnomを徹底解剖することで，Rustの強力な言語機能を使ったパーサライブラリの実装方法を学びました．<br>
トレイトやジェネリクスの機能等の機能を活用することでRustっぽいキレイなコードを書くことができますが，<br>
意識せず惰性で作っているとごちゃっとしたコードが出来上がってしまいがちです．<br>
今回のコードリーディングはそのような自分のプログラミングに喝を入れるという意味でとても勉強になりました．</p>
<p>今回取り上げた関数以外にも非常に多くの機能が実現されているnomですが，<br>
本記事で身につけた知識を活かせば，実装を読むことはそう難しくないはずです．<br>
使い方のサンプルが紹介されていない関数についても，今回踏んだ流れで読んでいけば使えそうですね．</p>
<h2 id="余談-ipfactoryについて" class="headerLink">
    <a href="#%e4%bd%99%e8%ab%87-ipfactory%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6" class="header-mark"></a>5 余談: IPFactoryについて</h2><p>IPFactoryとは，情報科学専門学校という学校に存在する学内サークルです．<br>
IPFに在籍するメンバーがそれぞれ自身の専門分野についての勉強やアウトプット活動を行っています．<br>
サークル内有志メンバーで <strong><a href="https://caya8.hatenablog.com/entry/2020/10/28/080123" target="_blank" rel="noopener noreferrer">CTFを主催</a></strong> したりもしています．<br>
IPFに所属する各メンバーのTwitterやブログ等は <a href="https://ipfactory.github.io/" target="_blank" rel="noopener noreferrer">こちらのページ</a> を参照してください．</p>
<h2 id="余談2-nombranchalt-について" class="headerLink">
    <a href="#%e4%bd%99%e8%ab%872-nombranchalt-%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6" class="header-mark"></a>6 余談2: <code>nom::branch::alt</code> について</h2><p>ここらへんのツイートが関連しています．<br>
[https://twitter.com/drumato/status/1329698474049249280:embed]</p>
<p>先述したように，<br>
<code>nom::branch::alt</code> は引数に <a href="https://docs.rs/nom/6.0.0/nom/branch/trait.Alt.html" target="_blank" rel="noopener noreferrer"><code>nom::branch::Alt</code></a> トレイトを実装することを強制しています．<br>
<code>nom::branch::Alt</code> は <strong>パーサのリスト</strong> に対して実装されていて，<br>
リストの要素である各パーサは <code>nom::Parser</code> トレイトが実装されていることになっています．</p>
<p><a href="https://docs.rs/nom/6.0.0/src/nom/internal.rs.html#282-289" target="_blank" rel="noopener noreferrer">実際の定義</a> を見てみると，<br>
<code>FnMut(I) -&gt; nom::IResult&lt;I, O, E&gt;</code> トレイトを実装する引数は全て受け取れるようになっていますが，<br>
<code>nom::branch::alt</code> にインプット以外の資源を渡したいことがあります．</p>
<p>わたしが実際に取り組んでいる <a href="https://github.com/Drumato/peachili/blob/replace-parser/src/compiler/common/frontend/pass/parser/expression.rs" target="_blank" rel="noopener noreferrer">自作コンパイラ</a> では，<br>
ASTの実装に <a href="https://crates.io/crates/typed-arena" target="_blank" rel="noopener noreferrer"><code>typed-arena</code></a> を使用している為に，<br>
アリーナアロケータを使いまわしたい，というモチベーションがあります．</p>
<p>Rustの型システムの限界か?(というかそれこそが型システムの恩恵なので当たり前なんですが)と思いとても困っていたのですが，<br>
そこで <a href="https://twitter.com/blackenedgold" target="_blank" rel="noopener noreferrer">keen</a> さんの <a href="https://github.com/KeenS/webml" target="_blank" rel="noopener noreferrer">webml</a> という実装を見つけました．</p>
<p>この実装を見ると，構造体メソッドとして実装された各パーサ関数が <strong><code>FnMut(I) -&gt; nom::IResult&lt;I, O, E&gt;</code> を実現するクロージャを返す</strong> ようになっています．<br>
クロージャ内部では構造体のメンバやパーサ関数に渡される引数を利用しても上手くキャプチャされ，<br>
返されるクロージャは上記トレイトを返すので <code>nom::branch::alt</code> に渡すことができるという仕組みです．</p>
<p>非常に感動し，すぐに私の実装にも取り入れました．<br>
<a href="https://github.com/Drumato/peachili/blob/replace-parser/src/compiler/common/frontend/pass/parser/expression.rs#L58" target="_blank" rel="noopener noreferrer">こちら</a> などが参考になるかと．</p>
<p>Keenさんの実装にはとても助けられました．<br>
ここで改めて紹介しておきたいとおもいます．</p>
</div>

        <div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2020-12-01</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="#" onclick="return false;" title="Share on Twitter" data-sharer="twitter" data-url="http://drumato.com/ja/posts/dive-into-nom/" data-title="Rust製のパーサコンビネータnom v6.0.0を解剖する" data-hashtags="parser-combinator,code-reading,nom,rust"><i class="fab fa-twitter fa-fw"></i></a><a href="#" onclick="return false;" title="Share on Facebook" data-sharer="facebook" data-url="http://drumato.com/ja/posts/dive-into-nom/" data-hashtag="parser-combinator"><i class="fab fa-facebook-square fa-fw"></i></a><a href="#" onclick="return false;" title="Share on Hacker News" data-sharer="hackernews" data-url="http://drumato.com/ja/posts/dive-into-nom/" data-title="Rust製のパーサコンビネータnom v6.0.0を解剖する"><i class="fab fa-hacker-news fa-fw"></i></a><a href="#" onclick="return false;" title="Share on Reddit" data-sharer="reddit" data-url="http://drumato.com/ja/posts/dive-into-nom/"><i class="fab fa-reddit fa-fw"></i></a><a href="#" onclick="return false;" title="Share on Line" data-sharer="line" data-url="http://drumato.com/ja/posts/dive-into-nom/" data-title="Rust製のパーサコンビネータnom v6.0.0を解剖する"><i data-svg-src="/lib/simple-icons/icons/line.min.svg"></i></a><a href="#" onclick="return false;" title="Share on Pocket" data-sharer="pocket" data-url="http://drumato.com/ja/posts/dive-into-nom/"><i class="fab fa-get-pocket fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/ja/tags/parser-combinator/">parser-combinator</a>,&nbsp;<a href="/ja/tags/code-reading/">code-reading</a>,&nbsp;<a href="/ja/tags/nom/">nom</a>,&nbsp;<a href="/ja/tags/rust/">rust</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/ja/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/ja/posts/tuipeach/" class="prev" rel="prev" title="TUI Based ELF Analyzer in Rust"><i class="fas fa-angle-left fa-fw"></i>TUI Based ELF Analyzer in Rust</a>
            <a href="/ja/posts/dive-into-combine/" class="next" rel="next" title="Rust製のパーサコンビネータcombine v4.4.0を覗き見する">Rust製のパーサコンビネータcombine v4.4.0を覗き見する<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">
                    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreferrer" title="Hugo 0.108.0">Hugo</a>&nbsp;|&nbsp;Theme - <a href="https://github.com/HEIGE-PCloud/DoIt" target="_blank" rel="noopener noreferrer" title="DoIt 0.2.13"><i class="far fa-edit fa-fw"></i> DoIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/ja/" target="_blank" rel="noopener noreferrer">Drumato</a></span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="Back to Top">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
            <i class="fas fa-comment fa-fw"></i>
        </a>
    </div><div class="assets"><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/fuse/fuse.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/topbar/topbar.min.js"></script><script type="text/javascript" src="/lib/pjax/pjax.min.js"></script><script type="text/javascript" src="/js/theme.min.js" defer></script></div>

<div class="pjax-assets"><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{},"data":{"desktop-header-typeit":"drumato.com","mobile-header-typeit":"drumato.com"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"distance":100,"findAllMatches":false,"fuseIndexURL":"/ja/index.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"No results found","snippetLength":30,"threshold":0.3,"type":"fuse","useExtendedSearch":false},"sharerjs":true,"typeit":{"cursorChar":null,"cursorSpeed":null,"data":{"desktop-header-typeit":["desktop-header-typeit"],"mobile-header-typeit":["mobile-header-typeit"]},"duration":null,"speed":null}};</script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/typeit/typeit.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js" defer></script><script type="text/javascript" src="/lib/katex/auto-render.min.js" defer></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js" defer></script><script type="text/javascript" src="/lib/katex/mhchem.min.js" defer></script><script type="text/javascript" src="/js/katex.min.js" defer></script><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/katex/copy-tex.min.css">
        <noscript><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"></noscript></div>
</body>

</html>