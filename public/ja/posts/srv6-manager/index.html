<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title class="pjax-title">Replace FRR Zebra SRv6 Manager with YANG Backend - drumato.com</title><meta name="Description" content=""><meta property="og:title" content="Replace FRR Zebra SRv6 Manager with YANG Backend" />
<meta property="og:description" content="私は現在趣味で FRRouting の開発に手を出しており， ちょこちょこ遊んだり，contribution chanceを狙っているのですが(mainstream" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://drumato.com/ja/posts/srv6-manager/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-01-04T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-01-04T00:00:00+00:00" /><meta property="og:site_name" content="drumato.com" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Replace FRR Zebra SRv6 Manager with YANG Backend"/>
<meta name="twitter:description" content="私は現在趣味で FRRouting の開発に手を出しており， ちょこちょこ遊んだり，contribution chanceを狙っているのですが(mainstream"/>
<meta name="application-name" content="drumato.com">
<meta name="apple-mobile-web-app-title" content="drumato.com">

<meta name="theme-color" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="http://drumato.com/ja/posts/srv6-manager/" /><link rel="prev" href="http://drumato.com/ja/posts/kubectl-plugin-builder/" /><link rel="next" href="http://drumato.com/ja/posts/parsecomb/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/fontawesome-free/all.min.css">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/animate/animate.min.css">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Replace FRR Zebra SRv6 Manager with YANG Backend",
        "inLanguage": "ja",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/drumato.com\/ja\/posts\/srv6-manager\/"
        },"genre": "posts","keywords": "frr, srv6","wordcount":  6750 ,
        "url": "http:\/\/drumato.com\/ja\/posts\/srv6-manager\/","datePublished": "2022-01-04T00:00:00+00:00","dateModified": "2022-01-04T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": "Drumato"},"author": {
                "@type": "Person",
                "name": "Drumato"
            },"description": ""
    }
    </script></head>

<body header-desktop="" header-mobile=""><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme); document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark');}
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' || theme === 'black' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('' === 'light' || '' === 'dark' || '' === 'black') setTheme(''), saveTheme(''); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627','black': '#000000'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/ja/" title="drumato.com"><span id="desktop-header-typeit" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/ja/about/"> About </a><a class="menu-item" href="/ja/posts/"> 記事一覧 </a><a class="menu-item" href="/ja/diaries/"> 日記一覧 </a><a class="menu-item" href="/ja/thissite/"> このサイトについて </a><span class="menu-item delimiter"></span><a href="#" onclick="return false;" class="menu-item language" title="Select Language">Japanese<i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" title="Select Language" id="language-select-desktop" onchange="location = this.value;"><option value="/posts/srv6-manager/">English</option><option value="/ja/posts/srv6-manager/" selected>Japanese</option></select>
                    </a><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="#" onclick="return false;" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" onclick="return false;" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="#" onclick="return false;" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/ja/" title="drumato.com"><span id="mobile-header-typeit" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="#" onclick="return false;" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" onclick="return false;" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="#" onclick="return false;" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/ja/about/" title="">About</a><a class="menu-item" href="/ja/posts/" title="">記事一覧</a><a class="menu-item" href="/ja/diaries/" title="">日記一覧</a><a class="menu-item" href="/ja/thissite/" title="">このサイトについて</a><a href="#" onclick="return false;" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a><a href="#" onclick="return false;" class="menu-item" title="Select Language">Japanese<i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" title="Select Language" onchange="location = this.value;"><option value="/posts/srv6-manager/">English</option><option value="/ja/posts/srv6-manager/" selected>Japanese</option></select>
                </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><div class="toc" id="toc-auto">
        <h2 class="toc-title">Contents</h2>
        <div class="toc-content" id="toc-content-auto"><nav id="TableOfContents">
  <ul>
    <li><a href="#前提知識">前提知識</a>
      <ul>
        <li><a href="#frr-zebra-srv6-manager">FRR Zebra SRv6 Manager</a></li>
        <li><a href="#northbound-grpc">Northbound gRPC</a></li>
        <li><a href="#frr-yang-backend">FRR YANG backend</a></li>
      </ul>
    </li>
    <li><a href="#本題">本題</a>
      <ul>
        <li><a href="#現状">現状</a></li>
        <li><a href="#目標">目標</a></li>
      </ul>
    </li>
    <li><a href="#現段階での実装">現段階での実装</a>
      <ul>
        <li><a href="#yang-fileの定義">YANG fileの定義</a></li>
        <li><a href="#northbound-api-callbacks">Northbound API Callbacks</a></li>
        <li><a href="#srv6-manager-cli">SRv6 Manager CLI</a></li>
      </ul>
    </li>
    <li><a href="#今後取り組むべきこと">今後取り組むべきこと</a>
      <ul>
        <li><a href="#segment-routing-blockの扱い"><code>segment-routing</code> blockの扱い</a></li>
        <li><a href="#show-yang-operational-data"><code>show yang operational-data</code></a></li>
        <li><a href="#mgmtdについての調査と検証">mgmtdについての調査と検証</a></li>
      </ul>
    </li>
    <li><a href="#まとめ">まとめ</a></li>
    <li><a href="#参考資料">参考資料</a></li>
  </ul>
</nav></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle", "normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Replace FRR Zebra SRv6 Manager with YANG Backend</h1><div class="post-meta">
            <div class="post-meta-line">
                <span class="post-author"><i class="author fas fa-user-circle fa-fw"></i><a href="/ja/" title="Author" rel=" author" class="author">Drumato</a>
                </span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-01-04">2022-01-04</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime="2022-01-04">2022-01-04</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;6750 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;14 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#前提知識">前提知識</a>
      <ul>
        <li><a href="#frr-zebra-srv6-manager">FRR Zebra SRv6 Manager</a></li>
        <li><a href="#northbound-grpc">Northbound gRPC</a></li>
        <li><a href="#frr-yang-backend">FRR YANG backend</a></li>
      </ul>
    </li>
    <li><a href="#本題">本題</a>
      <ul>
        <li><a href="#現状">現状</a></li>
        <li><a href="#目標">目標</a></li>
      </ul>
    </li>
    <li><a href="#現段階での実装">現段階での実装</a>
      <ul>
        <li><a href="#yang-fileの定義">YANG fileの定義</a></li>
        <li><a href="#northbound-api-callbacks">Northbound API Callbacks</a></li>
        <li><a href="#srv6-manager-cli">SRv6 Manager CLI</a></li>
      </ul>
    </li>
    <li><a href="#今後取り組むべきこと">今後取り組むべきこと</a>
      <ul>
        <li><a href="#segment-routing-blockの扱い"><code>segment-routing</code> blockの扱い</a></li>
        <li><a href="#show-yang-operational-data"><code>show yang operational-data</code></a></li>
        <li><a href="#mgmtdについての調査と検証">mgmtdについての調査と検証</a></li>
      </ul>
    </li>
    <li><a href="#まとめ">まとめ</a></li>
    <li><a href="#参考資料">参考資料</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>私は現在趣味で <a href="https://frrouting.org/" target="_blank" rel="noopener noreferrer">FRRouting</a> の開発に手を出しており，
ちょこちょこ遊んだり，contribution chanceを狙っているのですが(mainstream mergeは2回のみ経験)，
その中でも現在取り組んでいるSRv6 ManagerのYANG backend対応です．
これはNorthbound APIという興味深い仕組みに関わるものであり，とてもやりごたえがあるtaskです．
日々ウンウン唸りながら頑張ってcodingしているので，その内容をまとめておこうと思います．
本実装の内容はまだ不完全であり，実装方針のmemoみたいな側面が大きいですが，
ともかく何かしら知見になるかもしれないので．
本記事が対象とするPoCは <a href="https://github.com/Drumato/frr/pull/4" target="_blank" rel="noopener noreferrer">こちら</a> に．</p>
<hr>
<h2 id="前提知識" class="headerLink">
    <a href="#%e5%89%8d%e6%8f%90%e7%9f%a5%e8%ad%98" class="header-mark"></a>1 前提知識</h2><p>ここではごく簡単に事前知識を共有します．</p>
<h3 id="frr-zebra-srv6-manager" class="headerLink">
    <a href="#frr-zebra-srv6-manager" class="header-mark"></a>1.1 FRR Zebra SRv6 Manager</h3><p>まず，FRRではZebra daemonがSRv6 locator等の資源を管理しており，
bgpdやisisdなどのrouting daemonはzebraに問い合わせることでそれら資源の使用権を受け取り，
それらを広報などに使用する，というような <strong>&ldquo;server - client&rdquo; model</strong> を採用しています．
このうち前者，Zebraに存在するSRv6資源の管理者を <strong>SRv6 Manager</strong> と呼びます．
FRR repoには <a href="https://github.com/FRRouting/frr/tree/frr-8.1/tests/topotests/bgp_srv6l3vpn_to_bgp_vrf" target="_blank" rel="noopener noreferrer">BGP SRv6でVPNv6を構築するtopotest</a> が置いてあるので，
その内容を読んでみると仕組みがわかりやすいかなと思います．</p>
<h3 id="northbound-grpc" class="headerLink">
    <a href="#northbound-grpc" class="header-mark"></a>1.2 Northbound gRPC</h3><p>FRRoutingで最もpopularかつ手軽に扱えるdynamic configuration interfaceにvtyshがあります．
これはCisco routerなどで使用できるInteractive CLIとほぼ同等の機能を提供するものです．</p>
<p>一方，FRRは <strong>Northbound gRPC</strong> と呼ばれる，
gRPC communicationによるNorthbound APIの提供を実装しています．
userはgRPC clientを実装して使用することで，それぞれのrouting daemonに対するRPCを発行でき，
programmableにnetwork configurationを行える，というものです．
詳細は <a href="http://docs.frrouting.org/en/latest/grpc.html" target="_blank" rel="noopener noreferrer">こちらのdocument</a> や <a href="http://docs.frrouting.org/projects/dev-guide/en/latest/grpc.html" target="_blank" rel="noopener noreferrer">こちら</a> を御覧ください．</p>
<h3 id="frr-yang-backend" class="headerLink">
    <a href="#frr-yang-backend" class="header-mark"></a>1.3 FRR YANG backend</h3><p>先述したNorthbound gRPCですが，FRRではこれを以下のようにして実現しています．</p>
<ul>
<li><strong><a href="https://datatracker.ietf.org/doc/html/rfc7950" target="_blank" rel="noopener noreferrer">YANG</a></strong> でFRRが扱う資源をmodeling</li>
<li>上記Data Modelに <strong>Northbound API Callbacks</strong> を紐付ける</li>
</ul>
<p>このように，YANG data storeを中心とした実装にする利点はいくつか存在します．
まず1つ目に，operatorはYANG fileを参照するだけで <strong>&ldquo;何がreadonlyで，何がoperationalで&rdquo;</strong> というのを確認できます．
YANGは特定のprogramming language, 及び実装に依存しないので，network engineerなら誰でも理解することができます．
2つ目に，Ciscoなどのnetwork vendorはそれぞれの製品が使用する <a href="https://github.com/YangModels/yang" target="_blank" rel="noopener noreferrer">YANG modelを公開</a> しています．
実装の中心にYANGを置き，それをnetwork vendorとcompatibilityがあるように整備すれば，
できるだけcisco routerなどと同じように扱うことができます．</p>
<hr>
<h2 id="本題" class="headerLink">
    <a href="#%e6%9c%ac%e9%a1%8c" class="header-mark"></a>2 本題</h2><h3 id="現状" class="headerLink">
    <a href="#%e7%8f%be%e7%8a%b6" class="header-mark"></a>2.1 現状</h3><p>先述したようにFRRのdaemonをYANG backendに置き換えることには大きなmotivationがあり，
<strong><a href="https://github.com/FRRouting/frr/issues/5428" target="_blank" rel="noopener noreferrer">FRR communityでも2019年頃から率先して置き換えよう</a></strong> という動きがありました．
本記事の内容からは離れますが， <strong><a href="https://github.com/FRRouting/frr/pull/10000" target="_blank" rel="noopener noreferrer">mgmtdという新たなplatformを導入しようという動き</a></strong> もあります．
そこで私は，このYANG backendの実装を通じてFRRについて詳しくなろうと思いました．</p>
<p>先述したZebra SRv6 Managerは現在YANG backendに非対応であり，従来のprimitiveな方法で実装されていますが，
SRv6 Managerはその責任と仕事に反して小さな規模で実装されており，また読みやすく注意されています．
私はSRv6 Manager全体を大まかに読んだ経験もあるため，&ldquo;土地勘&quot;もあるし，書き換えるイメージもなんとなくできていました．
ということで，現在私はSRv6 ManagerをYANG backendに置き換えようと取り組んでいます．
最終的に，mainstreamへのmergeを行うかはとりあえずおいておいて，
私がFRRを勉強したり，それについての知見を共有できるところを目指します．</p>
<h3 id="目標" class="headerLink">
    <a href="#%e7%9b%ae%e6%a8%99" class="header-mark"></a>2.2 目標</h3><p>ここまでの状況をもとに，本taskの目標を整理してみます．</p>
<ul>
<li>それぞれのcomponentをpracticalに置き換えること
<ul>
<li>daemon side</li>
<li>SRv6 Manager vtysh command</li>
<li>config management</li>
</ul>
</li>
<li>もちろんSRv6 Managerとしての機能は損なわないこと
<ul>
<li>topotestsで使われているSRv6 Managerの機能は動作すること</li>
</ul>
</li>
</ul>
<hr>
<h2 id="現段階での実装" class="headerLink">
    <a href="#%e7%8f%be%e6%ae%b5%e9%9a%8e%e3%81%a7%e3%81%ae%e5%ae%9f%e8%a3%85" class="header-mark"></a>3 現段階での実装</h2><p>ここからは実際に，どのようにしてこれを実現しているかを解説していきます．
本taskのPoCは，以下3つのsub-taskに分けて考える事ができます．</p>
<ul>
<li>YANG fileの定義</li>
<li>YANG data nodeに対応するcallbackの定義，実装</li>
<li>vtyshの実装変更</li>
</ul>
<p>現在は，srv6_locatorというSRv6 Managerの機能に関するtopotestが存在し，
それがうまく動くまで実装できています．</p>
<h3 id="yang-fileの定義" class="headerLink">
    <a href="#yang-file%e3%81%ae%e5%ae%9a%e7%be%a9" class="header-mark"></a>3.1 YANG fileの定義</h3><p>まずはじめに，data modelとなるYANG fileの定義を行います．
このfileはdaemon/vtyshの実装の基点となるため，慎重に設計する必要があり，これは簡単ではありません．
そこで現在は，IOS-XR 7.5.1のYANGを参照して設計しています．
CiscoやJuniperなどのnetwork vendorは使用しているyangを公開しており，
それを参考にすることでwell-definedなYANGを設計することができます．
例えば，CiscoのYANGは <a href="https://github.com/YangModels/yang/tree/master/vendor/cisco" target="_blank" rel="noopener noreferrer">こちら</a> にあります．</p>
<p>SRv6に関するyangを探してみると，大別して以下の種類が存在することがわかります．
このうち，まずは <code>cfg</code> と <code>datatypes</code> に絞って考えることにします．</p>
<ul>
<li><a href="https://github.com/YangModels/yang/blob/master/vendor/cisco/xr/751/Cisco-IOS-XR-segment-routing-srv6-oper.yang" target="_blank" rel="noopener noreferrer">Cisco-IOS-XR-segment-routing-srv6-oper.yang</a></li>
<li><a href="https://github.com/YangModels/yang/blob/master/vendor/cisco/xr/751/Cisco-IOS-XR-segment-routing-srv6-datatypes.yang" target="_blank" rel="noopener noreferrer">Cisco-IOS-XR-segment-routing-srv6-datatypes.yang</a></li>
<li><a href="https://github.com/YangModels/yang/blob/master/vendor/cisco/xr/751/Cisco-IOS-XR-segment-routing-srv6-cfg.yang" target="_blank" rel="noopener noreferrer">Cisco-IOS-XR-segment-routing-srv6-cfg.yang</a></li>
</ul>
<p>さて，このyangを読んでみると， <code>segment-routing-srv6-cfg:srv6</code> というcontainer blockは <code>segment-routing-ms-cfg:sr</code> をaugmentする形で作られています．
これはSegment Routing自体のdata modelであり，そのsub treeとしてsrv6 blockが付属するようになっているのです．
これを踏襲して，本PoCでは以下のようなyangを用意します．
現状，FRRのZebraにSegment Routing自体の統一的な基盤はありませんが(後述)，それはひとまず考えないことにします．</p>
<ul>
<li><code>frr-srv6.yang</code> &hellip; <code>segment-routing-srv6-datatypes</code> 相当のyang</li>
<li><code>frr-zebra-sr.yang</code> &hellip; <code>segment-routing-ms-cfg</code> 相当のyang
<ul>
<li>SRv6 Managerとはあまり関係ないが，今後必要になるかもしれない</li>
</ul>
</li>
<li><code>frr-zebra-srv6.yang</code> &hellip; <code>segment-routing-srv6-cfg</code> 相当のyang
<ul>
<li><code>frr-zebra-sr</code> をaugmentする</li>
</ul>
</li>
</ul>
<p>yangの内容をすべて取り上げるのは大変なので，PoCをご覧いただければと思います．
後々，vtyshの実装を紹介する際にxpathの内容を見るので，そこでなんとなく感覚がつかめると思います．</p>
<h3 id="northbound-api-callbacks" class="headerLink">
    <a href="#northbound-api-callbacks" class="header-mark"></a>3.2 Northbound API Callbacks</h3><p>YANGでSRv6に関するdata modelを記述したあとは，それぞれのdata nodeに対してNorthbound API callbacksを実装する必要があります．
例えばisisdでは， <code>router isis AREA_TAG</code> として新しいisis instanceを作成しますが，
これに対応してYANG list-nodeのentryが新しく作成され，data storeに保存されるようになっています．
これはFRR内で <code>NB_OP_CREATE</code> と呼ばれるAPI callによって行われ，
また， <code>create</code> と呼ばれるcallbackが紐付いて呼ばれるようになっています．
ここでは簡単にNorthbound APIで使用されるCallback(の一部)について解説しておきます．</p>
<table>
<thead>
<tr>
<th style="text-align:center">Callback</th>
<th style="text-align:center">Type</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>create</code></td>
<td style="text-align:center">Configuration</td>
<td style="text-align:center">list-node entry/type empty/leaf-list entryの作成時に呼ばれる</td>
</tr>
<tr>
<td style="text-align:center"><code>modify</code></td>
<td style="text-align:center">Configuration</td>
<td style="text-align:center">leaf-node valueが変更される際に呼ばれる</td>
</tr>
<tr>
<td style="text-align:center"><code>destroy</code></td>
<td style="text-align:center">Configuration</td>
<td style="text-align:center">あるlist-node entry/leaf-list entry/etcが削除される際に呼ばれる</td>
</tr>
<tr>
<td style="text-align:center"><code>get_elem</code></td>
<td style="text-align:center">Operation</td>
<td style="text-align:center">あるleaf/leaf-list entry/etcを取得するcallbackで，operational-dataを取得する際に呼ばれる</td>
</tr>
<tr>
<td style="text-align:center"><code>lookup_entry</code></td>
<td style="text-align:center">Operation</td>
<td style="text-align:center">あるlist-nodeについて，あるkeyを持つentryを探索する</td>
</tr>
<tr>
<td style="text-align:center"><code>cli_show</code></td>
<td style="text-align:center">Operation</td>
<td style="text-align:center">あるnodeに対応するCLI commandを出力する</td>
</tr>
<tr>
<td style="text-align:center"><code>cli_show_end</code></td>
<td style="text-align:center">Operation</td>
<td style="text-align:center">container/listnodeなどはCLI command blockを生成するため，そのterminationを出力する</td>
</tr>
</tbody>
</table>
<p>これらcallbackを，先述したYANGに対して定義する，というのが次のtaskです．
まずは <code>struct frr_yang_module_info</code> という構造体を定義して，
daemonのinstantiation( <code>FRR_DAEMON_INFO</code> というmacroで行われます )時に引き渡すという実装を行います．</p>
<p><a href="https://github.com/Drumato/frr/blob/a41251800b09b9b93726a18fb891127a3e10340b/zebra/zebra_srv6_nb.c#L31" target="_blank" rel="noopener noreferrer">https://github.com/Drumato/frr/blob/a41251800b09b9b93726a18fb891127a3e10340b/zebra/zebra_srv6_nb.c#L31</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* stripped */</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="k">struct</span> <span class="n">frr_yang_module_info</span> <span class="n">frr_zebra_srv6_info</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;frr-zebra-srv6&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="p">.</span><span class="n">xpath</span> <span class="o">=</span> <span class="s">&#34;/frr-zebra-sr:sr/frr-zebra-srv6:srv6&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">.</span><span class="n">cbs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">cli_show</span> <span class="o">=</span> <span class="n">cli_show_segment_routing_srv6</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">cli_show_end</span> <span class="o">=</span> <span class="n">cli_show_segment_routing_srv6_end</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="p">.</span><span class="n">priority</span> <span class="o">=</span> <span class="n">NB_DFLT_PRIORITY</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="p">.</span><span class="n">xpath</span> <span class="o">=</span> <span class="s">&#34;/frr-zebra-sr:sr/frr-zebra-srv6:srv6/locators&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">.</span><span class="n">cbs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">cli_show</span> <span class="o">=</span> <span class="n">cli_show_srv6_locators</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">cli_show_end</span> <span class="o">=</span> <span class="n">cli_show_srv6_locators_end</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="p">.</span><span class="n">xpath</span> <span class="o">=</span> <span class="s">&#34;/frr-zebra-sr:sr/frr-zebra-srv6:srv6/locators/locators&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">.</span><span class="n">cbs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">cli_show</span> <span class="o">=</span> <span class="n">cli_show_srv6_locators_locators</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">cli_show_end</span> <span class="o">=</span> <span class="n">cli_show_srv6_locators_locators_end</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="p">.</span><span class="n">xpath</span> <span class="o">=</span> <span class="s">&#34;/frr-zebra-sr:sr/frr-zebra-srv6:srv6/locators/locators/locator&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">.</span><span class="n">cbs</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">cli_show</span> <span class="o">=</span> <span class="n">cli_show_srv6_locator</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">cli_show_end</span> <span class="o">=</span> <span class="n">cli_show_srv6_locator_end</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">nb_lib_srv6_locator_create</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">destroy</span> <span class="o">=</span> <span class="n">nb_lib_srv6_locator_destroy</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* stripped */</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>同じようにして <code>struct frr_yang_module_info frr_zebra_sr_info</code> も定義します．
あとは，ここで指定したcallbacksを地道に頑張って実装していくだけです．
まずは， <code>nb_lib_srv6_locator_create</code> をご紹介します．
これは先述した <code>create</code> callbackであり，
新しいSRv6 locatorが作成された際に呼び出されます．
以下に示す，callbackの中身について解説します．</p>
<p>まず，FRRではいくつかの理由から， <strong>YANG data treeとそれに対応する状態を管理するC data</strong> の2つを管理しています．
YANGに対するlist-node appendは自動的に行われますが，
ここでは <code>zebra_srv6_locator_add()</code> を呼ぶことで，SRv6 Managerが管理するmaster変数を更新しています．</p>
<p>次に，このcallbackが呼び出された時点で <code>args</code> には対応するdnodeが格納されています．
また，API clientからnameが渡されているので(後述)，
それをもとにSRv6 Manager側の関数を呼び出してあげて初期化します．
また， <code>nb_running_set_entry()</code> という関数を呼び出します．
これによって，以後 <code>list locator</code> のchild nodeに対する <code>modify</code> callback等では，
lookup等を呼び出さずに 親nodeに対応する <code>struct srv6_locator</code> を引っ張ってこれます．</p>
<p><a href="https://github.com/Drumato/frr/blob/a41251800b09b9b93726a18fb891127a3e10340b/zebra/zebra_srv6_nb_config.c#L29" target="_blank" rel="noopener noreferrer">https://github.com/Drumato/frr/blob/a41251800b09b9b93726a18fb891127a3e10340b/zebra/zebra_srv6_nb_config.c#L29</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// stripped
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * XPath: /frr-zebra-sr:sr/frr-zebra-srv6:srv6/locators/locators/locator
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">nb_lib_srv6_locator_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">nb_cb_create_args</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">srv6_locator</span> <span class="o">*</span><span class="n">loc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">srv6_locator_chunk</span> <span class="o">*</span><span class="n">chunk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">loc_name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">!=</span> <span class="n">NB_EV_APPLY</span><span class="p">)</span> <span class="k">return</span> <span class="n">NB_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">loc_name</span> <span class="o">=</span> <span class="nf">yang_dnode_get_string</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">dnode</span><span class="p">,</span> <span class="s">&#34;./name&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">loc</span> <span class="o">=</span> <span class="nf">zebra_srv6_locator_lookup</span><span class="p">(</span><span class="n">loc_name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">loc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/* SRv6 manager pre-allocates one chunk for zclients */</span>
</span></span><span class="line"><span class="cl">    <span class="n">loc</span> <span class="o">=</span> <span class="nf">srv6_locator_alloc</span><span class="p">(</span><span class="n">loc_name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">chunk</span> <span class="o">=</span> <span class="nf">srv6_locator_chunk_alloc</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">chunk</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">=</span> <span class="n">NO_PROTO</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">listnode_add</span><span class="p">(</span><span class="n">loc</span><span class="o">-&gt;</span><span class="n">chunks</span><span class="p">,</span> <span class="n">chunk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">zebra_srv6_locator_add</span><span class="p">(</span><span class="n">loc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">nb_running_set_entry</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">dnode</span><span class="p">,</span> <span class="n">loc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">NB_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// stripped
</span></span></span></code></pre></div><p>続いてlocator prefixを変更する <code>nb_lib_srv6_locator_prefix_modify</code> をご紹介します．
これは <code>list locator</code> が管理する <code>leaf prefix</code> (厳密には <code>container prefix</code> を経由しています)を書き換える際に呼ばれる <code>modify</code> callbackです．
<code>nb_running_get_entry()</code> で対応する <code>struct srv6_locator</code> を引っ張ってきて， <code>prefix</code> を書き換えます．</p>
<p><a href="https://github.com/Drumato/frr/blob/a41251800b09b9b93726a18fb891127a3e10340b/zebra/zebra_srv6_nb_config.c#L124" target="_blank" rel="noopener noreferrer">https://github.com/Drumato/frr/blob/a41251800b09b9b93726a18fb891127a3e10340b/zebra/zebra_srv6_nb_config.c#L124</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// stripped
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * XPath: /frr-zebra-sr:sr/frr-zebra-srv6:srv6/locators/locators/locator/prefix/prefix
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">nb_lib_srv6_locator_prefix_modify</span><span class="p">(</span><span class="k">struct</span> <span class="n">nb_cb_modify_args</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">srv6_locator</span> <span class="o">*</span><span class="n">locator</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">!=</span> <span class="n">NB_EV_APPLY</span><span class="p">)</span> <span class="k">return</span> <span class="n">NB_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">locator</span> <span class="o">=</span> <span class="nf">nb_running_get_entry</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">dnode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">yang_dnode_get_prefix</span><span class="p">(</span><span class="o">&amp;</span><span class="n">locator</span><span class="o">-&gt;</span><span class="n">prefix</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">dnode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">NB_OK</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// stripped
</span></span></span></code></pre></div><p>このようにして地道にcallbackを定義したあと，
最終的に <code>struct frr_yang_module_info</code> を <code>FRR_DAEMON_INFO</code> に引き渡します．
Zebraはすでに <code>struct frr_yang_module_info *const zebra_yang_modules[]</code> を定義しているので，
それに私が定義したものを追加するだけでOKです．</p>
<p><a href="https://github.com/Drumato/frr/blob/a41251800b09b9b93726a18fb891127a3e10340b/zebra/main.c#L261" target="_blank" rel="noopener noreferrer">https://github.com/Drumato/frr/blob/a41251800b09b9b93726a18fb891127a3e10340b/zebra/main.c#L261</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// stripped
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">frr_yang_module_info</span> <span class="o">*</span><span class="k">const</span> <span class="n">zebra_yang_modules</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="o">&amp;</span><span class="n">frr_filter_info</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="o">&amp;</span><span class="n">frr_interface_info</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="o">&amp;</span><span class="n">frr_route_map_info</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="o">&amp;</span><span class="n">frr_zebra_info</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="o">&amp;</span><span class="n">frr_vrf_info</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="o">&amp;</span><span class="n">frr_routing_info</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="o">&amp;</span><span class="n">frr_srv6_info</span><span class="p">,</span> <span class="c1">// 追加
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">&amp;</span><span class="n">frr_zebra_route_map_info</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="o">&amp;</span><span class="n">frr_zebra_sr_info</span><span class="p">,</span> <span class="c1">// 追加
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">&amp;</span><span class="n">frr_zebra_srv6_info</span><span class="p">,</span> <span class="c1">// 追加
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// stripped
</span></span></span></code></pre></div><h3 id="srv6-manager-cli" class="headerLink">
    <a href="#srv6-manager-cli" class="header-mark"></a>3.3 SRv6 Manager CLI</h3><p>ここまででdaemon側のNorthbound API対応はできているのですが，
vtysh側の実装がdaemon側の関数を直接叩くように実装されているままなので，これを変更します．
具体的には，vtysh command側の実装を単なるNorthbound API callで実装することができます．
まずは， <code>srv6_locator_cmd</code> という， locator config modeに遷移するcommandの実装です．
まずxpathを構築しますが，このときに <code>name</code> を渡し，locatorの初期化時に使えるようにします．
あとは <code>nb_cli_enqueue_change()</code> でAPI callをenqueueして，
<code>apply_changes()</code> でこれを適用します．
この際に， <code>NB_OP_CREATE</code> を指定するのがpointです．</p>
<p><a href="https://github.com/Drumato/frr/blob/a41251800b09b9b93726a18fb891127a3e10340b/zebra/zebra_srv6_vty.c#L246" target="_blank" rel="noopener noreferrer">https://github.com/Drumato/frr/blob/a41251800b09b9b93726a18fb891127a3e10340b/zebra/zebra_srv6_vty.c#L246</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// stripped
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="nf">DEFPY_YANG_NOSH</span><span class="p">(</span><span class="n">srv6_locator</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">srv6_locator_cmd</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;locator LOC_NAME$name&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="n">SRV6_LOCATOR_CMD_STR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span> <span class="n">xpath</span><span class="p">[</span><span class="n">XPATH_MAXLEN</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rv</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">snprintf</span><span class="p">(</span><span class="n">xpath</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xpath</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">           <span class="s">&#34;/frr-zebra-sr:sr&#34;</span>
</span></span><span class="line"><span class="cl">           <span class="s">&#34;/frr-zebra-srv6:srv6&#34;</span>
</span></span><span class="line"><span class="cl">           <span class="s">&#34;/locators/locators/locator[name=&#39;%s&#39;]&#34;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nf">nb_cli_enqueue_change</span><span class="p">(</span><span class="n">vty</span><span class="p">,</span> <span class="n">xpath</span><span class="p">,</span> <span class="n">NB_OP_CREATE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">rv</span> <span class="o">=</span> <span class="nf">nb_cli_apply_changes</span><span class="p">(</span><span class="n">vty</span><span class="p">,</span> <span class="n">xpath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="n">CMD_SUCCESS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">VTY_PUSH_XPATH</span><span class="p">(</span><span class="n">SRV6_LOC_NODE</span><span class="p">,</span> <span class="n">xpath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">rv</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// stripped
</span></span></span></code></pre></div><p>続いて， <code>cli_show</code> callbackの実装をご紹介します．
<code>struct lyd_node *node</code> (FRRが使用するlibyang側の構造体) には対応するdata nodeが含まれています．</p>
<p><a href="https://github.com/Drumato/frr/blob/a41251800b09b9b93726a18fb891127a3e10340b/zebra/zebra_srv6_vty.c#L405" target="_blank" rel="noopener noreferrer">https://github.com/Drumato/frr/blob/a41251800b09b9b93726a18fb891127a3e10340b/zebra/zebra_srv6_vty.c#L405</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// stripped
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">cli_show_srv6_locator</span><span class="p">(</span><span class="k">struct</span> <span class="n">vty</span> <span class="o">*</span><span class="n">vty</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">lyd_node</span> <span class="o">*</span><span class="n">dnode</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="kt">bool</span> <span class="n">show_defaults</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">loc_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">loc_name</span> <span class="o">=</span> <span class="nf">yang_dnode_get_string</span><span class="p">(</span><span class="n">dnode</span><span class="p">,</span> <span class="s">&#34;./name&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nf">vty_out</span><span class="p">(</span><span class="n">vty</span><span class="p">,</span> <span class="s">&#34;   locator %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">loc_name</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// stripped
</span></span></span></code></pre></div><p>このようにcli_showを地道に実装していくと，Zebra SRv6に関するconfigがcli_showですべて置換できるようになります．
詳細は省略しますが，vtyshで <code>show running-config</code> を実行したときに <code>zebra_sr_config()</code> という関数が呼ばれます．
isisdと同じように，この関数もすべて <code>cli_show</code> で置換します．
FRRではすでに <code>nb_cli_show_dnode_cmds()</code> という，再帰的にdnodeのcli_showを呼び出してくれる便利な関数があります．
これを使用して，簡潔に記述することができます．</p>
<p><a href="https://github.com/Drumato/frr/blob/a41251800b09b9b93726a18fb891127a3e10340b/zebra/zebra_srv6_vty.c#L453" target="_blank" rel="noopener noreferrer">https://github.com/Drumato/frr/blob/a41251800b09b9b93726a18fb891127a3e10340b/zebra/zebra_srv6_vty.c#L453</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// stripped
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">int</span> <span class="nf">zebra_sr_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">vty</span> <span class="o">*</span><span class="n">vty</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">write_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">lyd_node</span> <span class="o">*</span><span class="n">dnode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nf">zebra_srv6_is_enable</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">dnode</span> <span class="o">=</span> <span class="nf">yang_dnode_get</span><span class="p">(</span><span class="n">running_config</span><span class="o">-&gt;</span><span class="n">dnode</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">                <span class="s">&#34;/frr-zebra-sr:sr&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="s">&#34;/frr-zebra-srv6:srv6&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">dnode</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">nb_cli_show_dnode_cmds</span><span class="p">(</span><span class="n">vty</span><span class="p">,</span> <span class="n">dnode</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">write_count</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">write_count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// stripped
</span></span></span></code></pre></div><hr>
<h2 id="今後取り組むべきこと" class="headerLink">
    <a href="#%e4%bb%8a%e5%be%8c%e5%8f%96%e3%82%8a%e7%b5%84%e3%82%80%e3%81%b9%e3%81%8d%e3%81%93%e3%81%a8" class="header-mark"></a>4 今後取り組むべきこと</h2><p>ここまででsrv6_locator topotestが動作するようになったのですが，
実際にNorthbound API backendとしてほしい機能はまだ存在します．
よって，ここからはそれについて解説します．
また，発展的話題として，先述したmgmtdについても少しだけ触れることにします．</p>
<h3 id="segment-routing-blockの扱い" class="headerLink">
    <a href="#segment-routing-block%e3%81%ae%e6%89%b1%e3%81%84" class="header-mark"></a>4.1 <code>segment-routing</code> blockの扱い</h3><p>現状FRRでSRv6 locatorを定義する際には，以下のように指定します(ref: <a href="https://github.com/FRRouting/frr/blob/master/tests/topotests/srv6_locator/r1/zebra.conf#L11" target="_blank" rel="noopener noreferrer">https://github.com/FRRouting/frr/blob/master/tests/topotests/srv6_locator/r1/zebra.conf#L11</a> )．</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">segment-routing
</span></span><span class="line"><span class="cl"> srv6
</span></span><span class="line"><span class="cl">  locators
</span></span><span class="line"><span class="cl">   locator loc1
</span></span><span class="line"><span class="cl">    prefix 2001:db8:1:1::/64
</span></span><span class="line"><span class="cl">   exit
</span></span><span class="line"><span class="cl">  exit
</span></span><span class="line"><span class="cl"> exit
</span></span><span class="line"><span class="cl">exit
</span></span></code></pre></div><p>一方，Cisco CLIは先述したものとは異なります(ref: <a href="https://www.cisco.com/c/en/us/td/docs/routers/asr9000/software/asr9k-r7-3/segment-routing/configuration/guide/b-segment-routing-cg-asr9000-73x/m-configure-srv6-usid.html?referring_site=RE&amp;pos=1&amp;page=https://www.cisco.com/c/en/us/td/docs/routers/asr9000/software/asr9k-r6-6/segment-routing/configuration/guide/b-segment-routing-cg-asr9000-66x/b-segment-routing-cg-asr9000-66x_chapter_011.html#Cisco_Concept.dita_9cdec09b-6edf-4bb8-8137-6d546bfe0093" target="_blank" rel="noopener noreferrer">https://www.cisco.com/c/en/us/td/docs/routers/asr9000/software/asr9k-r7-3/segment-routing/configuration/guide/b-segment-routing-cg-asr9000-73x/m-configure-srv6-usid.html?referring_site=RE&pos=1&page=https://www.cisco.com/c/en/us/td/docs/routers/asr9000/software/asr9k-r6-6/segment-routing/configuration/guide/b-segment-routing-cg-asr9000-66x/b-segment-routing-cg-asr9000-66x_chapter_011.html#Cisco_Concept.dita_9cdec09b-6edf-4bb8-8137-6d546bfe0093</a> )．</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">segment-routing srv6
</span></span><span class="line"><span class="cl"> locators
</span></span><span class="line"><span class="cl">  locator loc1
</span></span><span class="line"><span class="cl">   prefix 2001:db8:1:1::/64
</span></span><span class="line"><span class="cl">  exit
</span></span><span class="line"><span class="cl"> exit
</span></span><span class="line"><span class="cl">exit
</span></span></code></pre></div><p>この非一貫性を解消する，というtaskがあります．
FRRではpathdとZebra SRv6 Managerの双方で <code>SEGMENT_ROUITNG_NODE</code> ( <code>segment-routing</code> block) を定義しており，
またconfigure時に <code>--enable-pathd</code> を入力しないとZebra SRv6 vtysh commandsが動作しないという問題があります．
これを防ぐためには <code>segment-routing srv6</code> をうまく定義する必要がありますが，
私の調査ではこの実装にはいくつかの落とし穴があり，簡単ではありません．
しかしCisco CLIと同様の運用体験を実現するためには必要なpatchだと考えています．</p>
<h3 id="show-yang-operational-data" class="headerLink">
    <a href="#show-yang-operational-data" class="header-mark"></a>4.2 <code>show yang operational-data</code></h3><p>ここまでの実装はNorthbound API callbacksにおける configuration callbackに限定されており，
operational callbackは考慮されていません．
これによって， <code>show yang operational-data</code> などのcommandでSRv6資源の情報を取得したりすることはできません．
これは，PythonやGoなどでgrpc clientを実装してFRRにinteractした場合も同様です．</p>
<p>これを実現するためには <code>get_keys/get_next/get_elem/lookup_entry</code> 等のcallbackに対応する必要があります．
ここまでもそうだったのですが，依然として網羅的なdocumentは存在せず，FRRの実装を深く読み込んで理解しなければ動作させることはできません．</p>
<h3 id="mgmtdについての調査と検証" class="headerLink">
    <a href="#mgmtd%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6%e3%81%ae%e8%aa%bf%e6%9f%bb%e3%81%a8%e6%a4%9c%e8%a8%bc" class="header-mark"></a>4.3 mgmtdについての調査と検証</h3><p>先述したように，YANG basedにFRR managementを行うことに責任を持つmgmtdというdaemonが提案されています．
このdaemonは以下の機能を持ち，FRRの開発/運用体験を高めるという意味で非常に期待しています．</p>
<ul>
<li>API client等に対するfrontend interfaceの提供
<ul>
<li>running/candidate/startup datastoreが明確になり，わかりやすいAPIが定義される</li>
</ul>
</li>
<li>すべてのFRR daemonに対するbackend interfaceの提供
<ul>
<li>それぞれはmgmtdに対する問い合わせによってconfig/dataを操作する</li>
<li>これによりdaemonごとに異なる実装が減る</li>
</ul>
</li>
<li>Candidate Config CommitのRollback/History機能</li>
</ul>
<p>mgmtdはFRR全体を巻き込む大きな変更を伴いますが(ただし段階的にmigrationはできそう)，
これによって現在私が抱えている多くの実装上の問題が解消されるかもしれません．
なのでmgmtdの実現が待ち遠しいですし，積極的にcontributionしたいとも思っています．</p>
<p>初のmgmtd backend clientとしてstaticdが選ばれていますが，
これをbgpd含む他のrouting daemonに対応する，という仕事にはすごい魅力を感じます．
ぜひやってみたいですね．</p>
<hr>
<h2 id="まとめ" class="headerLink">
    <a href="#%e3%81%be%e3%81%a8%e3%82%81" class="header-mark"></a>5 まとめ</h2><p>今回は，FRRoutingを改造して遊んでいる様子をご紹介しました．
このように巨大で実績のあるOSSのcodingは魅力がありますし，
迅速な理解と環境構築，coding力など様々なskillを要求されるのはとても楽しいです．</p>
<p>しかし，FRRoutingへのcontributionはまだまだ足りないので，もっと頑張りたい．
できれば次のcontributionは，ちゃんとしたNetworking featureの実装をやりたいですね．</p>
<hr>
<h2 id="参考資料" class="headerLink">
    <a href="#%e5%8f%82%e8%80%83%e8%b3%87%e6%96%99" class="header-mark"></a>6 参考資料</h2><ul>
<li><a href="http://docs.frrouting.org/en/latest/grpc.html" target="_blank" rel="noopener noreferrer">http://docs.frrouting.org/en/latest/grpc.html</a>
<ul>
<li><a href="http://docs.frrouting.org/projects/dev-guide/en/latest/grpc.html" target="_blank" rel="noopener noreferrer">http://docs.frrouting.org/projects/dev-guide/en/latest/grpc.html</a></li>
</ul>
</li>
<li><a href="https://engineering.linecorp.com/ja/blog/internship2021-frrouting/" target="_blank" rel="noopener noreferrer">【インターンレポート】FRRouting IS-IS SRv6 Extension 設計と実装に関して</a></li>
<li><a href="https://github.com/FRRouting/frr/pull/5865" target="_blank" rel="noopener noreferrer">zebra: srv6 manager</a></li>
</ul>
</div>

        <div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2022-01-04</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="#" onclick="return false;" title="Share on Twitter" data-sharer="twitter" data-url="http://drumato.com/ja/posts/srv6-manager/" data-title="Replace FRR Zebra SRv6 Manager with YANG Backend" data-hashtags="frr,srv6"><i class="fab fa-twitter fa-fw"></i></a><a href="#" onclick="return false;" title="Share on Facebook" data-sharer="facebook" data-url="http://drumato.com/ja/posts/srv6-manager/" data-hashtag="frr"><i class="fab fa-facebook-square fa-fw"></i></a><a href="#" onclick="return false;" title="Share on Hacker News" data-sharer="hackernews" data-url="http://drumato.com/ja/posts/srv6-manager/" data-title="Replace FRR Zebra SRv6 Manager with YANG Backend"><i class="fab fa-hacker-news fa-fw"></i></a><a href="#" onclick="return false;" title="Share on Reddit" data-sharer="reddit" data-url="http://drumato.com/ja/posts/srv6-manager/"><i class="fab fa-reddit fa-fw"></i></a><a href="#" onclick="return false;" title="Share on Line" data-sharer="line" data-url="http://drumato.com/ja/posts/srv6-manager/" data-title="Replace FRR Zebra SRv6 Manager with YANG Backend"><i data-svg-src="/lib/simple-icons/icons/line.min.svg"></i></a><a href="#" onclick="return false;" title="Share on Pocket" data-sharer="pocket" data-url="http://drumato.com/ja/posts/srv6-manager/"><i class="fab fa-get-pocket fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/ja/tags/frr/">frr</a>,&nbsp;<a href="/ja/tags/srv6/">srv6</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/ja/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/ja/posts/kubectl-plugin-builder/" class="prev" rel="prev" title="Kubectl Plugin Builder"><i class="fas fa-angle-left fa-fw"></i>Kubectl Plugin Builder</a>
            <a href="/ja/posts/parsecomb/" class="next" rel="next" title="Go GenericsでつくるParser Combinator">Go GenericsでつくるParser Combinator<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">
                    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreferrer" title="Hugo 0.108.0">Hugo</a>&nbsp;|&nbsp;Theme - <a href="https://github.com/HEIGE-PCloud/DoIt" target="_blank" rel="noopener noreferrer" title="DoIt 0.2.13"><i class="far fa-edit fa-fw"></i> DoIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/ja/" target="_blank" rel="noopener noreferrer">Drumato</a></span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="Back to Top">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
            <i class="fas fa-comment fa-fw"></i>
        </a>
    </div><div class="assets"><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/fuse/fuse.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/topbar/topbar.min.js"></script><script type="text/javascript" src="/lib/pjax/pjax.min.js"></script><script type="text/javascript" src="/js/theme.min.js" defer></script></div>

<div class="pjax-assets"><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{},"data":{"desktop-header-typeit":"drumato.com","mobile-header-typeit":"drumato.com"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"distance":100,"findAllMatches":false,"fuseIndexURL":"/ja/index.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"No results found","snippetLength":30,"threshold":0.3,"type":"fuse","useExtendedSearch":false},"sharerjs":true,"typeit":{"cursorChar":null,"cursorSpeed":null,"data":{"desktop-header-typeit":["desktop-header-typeit"],"mobile-header-typeit":["mobile-header-typeit"]},"duration":null,"speed":null}};</script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/typeit/typeit.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js" defer></script><script type="text/javascript" src="/lib/katex/auto-render.min.js" defer></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js" defer></script><script type="text/javascript" src="/lib/katex/mhchem.min.js" defer></script><script type="text/javascript" src="/js/katex.min.js" defer></script><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/katex/copy-tex.min.css">
        <noscript><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"></noscript></div>
</body>

</html>