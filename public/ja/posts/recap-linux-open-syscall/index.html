<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title class="pjax-title">Linuxのopen(2) syscallをもう一度復習する - drumato.com</title><meta name="Description" content=""><meta property="og:title" content="Linuxのopen(2) syscallをもう一度復習する" />
<meta property="og:description" content="お久しぶりです． 最近は自作コンパイラや， YouTubeでのアウトプット活動 をやってたりしました． 現在インフラ部門での就職活動に取り組んでおり" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://drumato.com/ja/posts/recap-linux-open-syscall/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-01-24T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-01-24T00:00:00+00:00" /><meta property="og:site_name" content="drumato.com" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Linuxのopen(2) syscallをもう一度復習する"/>
<meta name="twitter:description" content="お久しぶりです． 最近は自作コンパイラや， YouTubeでのアウトプット活動 をやってたりしました． 現在インフラ部門での就職活動に取り組んでおり"/>
<meta name="application-name" content="drumato.com">
<meta name="apple-mobile-web-app-title" content="drumato.com">

<meta name="theme-color" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="http://drumato.com/ja/posts/recap-linux-open-syscall/" /><link rel="prev" href="http://drumato.com/ja/posts/type-system1/" /><link rel="next" href="http://drumato.com/ja/posts/cybozu-labs-youth-10th/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/fontawesome-free/all.min.css">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/animate/animate.min.css">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Linuxのopen(2) syscallをもう一度復習する",
        "inLanguage": "ja",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/drumato.com\/ja\/posts\/recap-linux-open-syscall\/"
        },"genre": "posts","keywords": "c, linux","wordcount":  5207 ,
        "url": "http:\/\/drumato.com\/ja\/posts\/recap-linux-open-syscall\/","datePublished": "2021-01-24T00:00:00+00:00","dateModified": "2021-01-24T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": "Drumato"},"author": {
                "@type": "Person",
                "name": "Drumato"
            },"description": ""
    }
    </script></head>

<body header-desktop="" header-mobile=""><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme); document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark');}
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' || theme === 'black' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('' === 'light' || '' === 'dark' || '' === 'black') setTheme(''), saveTheme(''); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627','black': '#000000'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/ja/" title="drumato.com"><span id="desktop-header-typeit" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/ja/about/"> About </a><a class="menu-item" href="/ja/posts/"> 記事一覧 </a><a class="menu-item" href="/ja/diaries/"> 日記一覧 </a><a class="menu-item" href="/ja/thissite/"> このサイトについて </a><span class="menu-item delimiter"></span><a href="#" onclick="return false;" class="menu-item language" title="Select Language">Japanese<i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" title="Select Language" id="language-select-desktop" onchange="location = this.value;"><option value="/ja/posts/recap-linux-open-syscall/" selected>Japanese</option></select>
                    </a><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="#" onclick="return false;" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" onclick="return false;" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="#" onclick="return false;" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/ja/" title="drumato.com"><span id="mobile-header-typeit" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="#" onclick="return false;" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" onclick="return false;" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="#" onclick="return false;" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/ja/about/" title="">About</a><a class="menu-item" href="/ja/posts/" title="">記事一覧</a><a class="menu-item" href="/ja/diaries/" title="">日記一覧</a><a class="menu-item" href="/ja/thissite/" title="">このサイトについて</a><a href="#" onclick="return false;" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a><a href="#" onclick="return false;" class="menu-item" title="Select Language">Japanese<i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" title="Select Language" onchange="location = this.value;"><option value="/ja/posts/recap-linux-open-syscall/" selected>Japanese</option></select>
                </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><div class="toc" id="toc-auto">
        <h2 class="toc-title">Contents</h2>
        <div class="toc-content" id="toc-content-auto"><nav id="TableOfContents">
  <ul>
    <li><a href="#ユーザから見るopen2">ユーザから見るopen(2)</a>
      <ul>
        <li><a href="#基本">基本</a>
          <ul>
            <li><a href="#o_append"><code>O_APPEND</code></a></li>
            <li><a href="#o_cloexec"><code>O_CLOEXEC</code></a></li>
            <li><a href="#o_creat"><code>O_CREAT</code></a></li>
            <li><a href="#o_directory"><code>O_DIRECTORY</code></a></li>
            <li><a href="#o_excl"><code>O_EXCL</code></a></li>
            <li><a href="#o_path"><code>O_PATH</code></a></li>
            <li><a href="#o_tmpfile"><code>O_TMPFILE</code></a></li>
            <li><a href="#o_trunc"><code>O_TRUNC</code></a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#カーネルから見るopen2">カーネルから見るopen(2)</a>
      <ul>
        <li><a href="#前提知識">前提知識</a></li>
        <li><a href="#大まかなコードリーディング">&ldquo;大まか&quot;なコードリーディング</a>
          <ul>
            <li><a href="#簡単なコールツリー">簡単なコールツリー</a></li>
            <li><a href="#syscall_define3"><code>SYSCALL_DEFINE3</code></a></li>
            <li><a href="#do_sys_open"><code>do_sys_open()</code></a></li>
            <li><a href="#build_open_how"><code>build_open_how()</code></a></li>
            <li><a href="#do_sys_openat2"><code>do_sys_openat2()</code></a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#まとめ">まとめ</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("pageStyle", "normal")</script><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Linuxのopen(2) syscallをもう一度復習する</h1><div class="post-meta">
            <div class="post-meta-line">
                <span class="post-author"><i class="author fas fa-user-circle fa-fw"></i><a href="/ja/" title="Author" rel=" author" class="author">Drumato</a>
                </span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-01-24">2021-01-24</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime="2021-01-24">2021-01-24</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;5207 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;11 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#ユーザから見るopen2">ユーザから見るopen(2)</a>
      <ul>
        <li><a href="#基本">基本</a>
          <ul>
            <li><a href="#o_append"><code>O_APPEND</code></a></li>
            <li><a href="#o_cloexec"><code>O_CLOEXEC</code></a></li>
            <li><a href="#o_creat"><code>O_CREAT</code></a></li>
            <li><a href="#o_directory"><code>O_DIRECTORY</code></a></li>
            <li><a href="#o_excl"><code>O_EXCL</code></a></li>
            <li><a href="#o_path"><code>O_PATH</code></a></li>
            <li><a href="#o_tmpfile"><code>O_TMPFILE</code></a></li>
            <li><a href="#o_trunc"><code>O_TRUNC</code></a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#カーネルから見るopen2">カーネルから見るopen(2)</a>
      <ul>
        <li><a href="#前提知識">前提知識</a></li>
        <li><a href="#大まかなコードリーディング">&ldquo;大まか&quot;なコードリーディング</a>
          <ul>
            <li><a href="#簡単なコールツリー">簡単なコールツリー</a></li>
            <li><a href="#syscall_define3"><code>SYSCALL_DEFINE3</code></a></li>
            <li><a href="#do_sys_open"><code>do_sys_open()</code></a></li>
            <li><a href="#build_open_how"><code>build_open_how()</code></a></li>
            <li><a href="#do_sys_openat2"><code>do_sys_openat2()</code></a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#まとめ">まとめ</a></li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>お久しぶりです．<br>
最近は自作コンパイラや，<br>
<a href="https://www.youtube.com/channel/UCUaqLN-HQUwLYRr2SEhmbxA" target="_blank" rel="noopener noreferrer">YouTubeでのアウトプット活動</a> をやってたりしました．</p>
<p>現在インフラ部門での就職活動に取り組んでおり，<br>
将来その分野で専門的に精進したいという思いから，<br>
Linuxに関する知識をもう一度整理しようと考えました．</p>
<p>今回はLinuxの機能でも特に中核を担う&quot;ファイル&quot;と，<br>
ファイルを扱う上でまず必要になる <code>open(2)</code> システムコールについてまとめます．<br>
基本的にはユーザ視点のドキュメントになりますが，<br>
Linuxカーネルにあるシステムコールの実装をちょっと覗き見するまでの記事です．</p>
<p>詳解UNIXプログラミング等，書籍の内容も含みます．</p>
<h2 id="ユーザから見るopen2" class="headerLink">
    <a href="#%e3%83%a6%e3%83%bc%e3%82%b6%e3%81%8b%e3%82%89%e8%a6%8b%e3%82%8bopen2" class="header-mark"></a>1 ユーザから見るopen(2)</h2><h3 id="基本" class="headerLink">
    <a href="#%e5%9f%ba%e6%9c%ac" class="header-mark"></a>1.1 基本</h3><p>まずはmanの内容を引っ張り出してきます．</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl">       <span class="kt">int</span> <span class="nf">open</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">       <span class="kt">int</span> <span class="nf">open</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">mode_t</span> <span class="n">mode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">       <span class="kt">int</span> <span class="nf">creat</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">,</span> <span class="kt">mode_t</span> <span class="n">mode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">       <span class="kt">int</span> <span class="nf">openat</span><span class="p">(</span><span class="kt">int</span> <span class="n">dirfd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">       <span class="kt">int</span> <span class="nf">openat</span><span class="p">(</span><span class="kt">int</span> <span class="n">dirfd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">mode_t</span> <span class="n">mode</span><span class="p">);</span>
</span></span></code></pre></div><p>引数にはファイルパスである <code>pathname</code> と，<br>
<code>open(2)</code> 時の挙動を制御する <code>flags</code> が存在します．<br>
また，<code>mode</code> は，<code>open(2)</code> によって新しくファイルが作成される場合，そのファイルに設定するパーミッションを設定します．</p>
<p>返り値の <code>int</code> 型はファイルディスクリプタを表しますが，<br>
何らかの原因で失敗した場合は-1を返します．</p>
<p>ファイルディスクリプタは非負の整数であるため <code>unsigned int</code> 型を返したくなりますが，<br>
C言語でエラーを表現する場合，負の数をエラーとする事は非常に多いのでしょうがないですね．<br>
<code>int open(const char *pathname, int flags, unsigned int *fd);</code> として， <code>fd</code> に書き込むという方式もよく取られます．<br>
こうすればエラーとファイルディスクリプタをうまく分けられるので，私がC言語でエラーを返す関数を定義する時はこのようにしがち．</p>
<p>実際に<code>open(2)</code>に渡されるフラグを見てみましょう．<br>
すべてのフラグについて解説するわけではなく，<br>
私の方で特筆すべきと判断した内容にのみ触れます．</p>
<h4 id="o_append" class="headerLink">
    <a href="#o_append" class="header-mark"></a>1.1.1 <code>O_APPEND</code></h4><p>ファイルを追加モードでオープンします．<br>
イメージしづらいと思うので実際に使ってみます．</p>
<p>以下のようなファイルを用意します．</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">Drumato
</span></span><span class="line"><span class="cl">123
</span></span></code></pre></div><p>次のようなCプログラムをコンパイル&amp;リンクして実行します．</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="s">&#34;New Drumato</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;sample.txt&#34;</span><span class="p">,</span> <span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">O_APPEND</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;open(2) failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">ssize_t</span> <span class="n">nbytes</span> <span class="o">=</span> <span class="nf">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">nbytes</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;write(2) failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>実行結果は以下のようになります．</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ gcc c.c
</span></span><span class="line"><span class="cl">$ ./a.out
</span></span><span class="line"><span class="cl">$ cat sample.txt
</span></span><span class="line"><span class="cl">Drumato
</span></span><span class="line"><span class="cl"><span class="m">123</span>
</span></span><span class="line"><span class="cl">New Drumato
</span></span></code></pre></div><p>上記Cプログラムは以下のCプログラムと同じように振る舞います．</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="s">&#34;New Drumato</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;sample.txt&#34;</span><span class="p">,</span> <span class="n">O_WRONLY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;open(2) failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">lseek</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SEEK_END</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;lseek(2) failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">ssize_t</span> <span class="n">nbytes</span> <span class="o">=</span> <span class="nf">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">nbytes</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;write(2) failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>つまり，<code>O_APPEND</code>によって開かれた<code>fd</code>は，<br>
ファイルのオフセットをファイル末尾に設定した状態でユーザに渡されます．</p>
<h4 id="o_cloexec" class="headerLink">
    <a href="#o_cloexec" class="header-mark"></a>1.1.2 <code>O_CLOEXEC</code></h4><p>プロセスの親子関係において，<br>
親プロセスが開いているファイルディスクリプタは，子プロセスにもそのまま引き継がれます．</p>
<p>この挙動を許したくない場合，つまり子プロセスにファイルディスクリプタ群をコピーしたくない場合，<br>
<code>open(2)</code> して開いたファイルディスクリプタに対して <code>fcntl(2)</code> を呼び出し，<br>
<code>FD_CLOEXEC</code> フラグを設定するというプログラムを書く必要があります．<br>
これを <strong><em>close-on-exec</em> フラグの設定</strong> といいます．</p>
<p>しかし， <code>open(2)</code> の呼び出し終了から <code>fcntl(2)</code> の呼び出しが行われるまでに，<br>
子プロセス等からfdを触られてしまうかもしれません．<br>
これを回避するためにLinux 2.6.23 以降から， <code>O_CLOEXEC</code> フラグを設定できるようになりました．<br>
<code>fcntl(2)</code> を明示的に呼び出さなくても，fdに対して<em>close-on-exec</em> フラグを設定してくれます．</p>
<p>実際に試してみましょう．<br>
まずは子プロセスを生成する親プロセスのプログラムを作ります．</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;dirent.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/wait.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">print_file_descriptors_by_current</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">open_sample_txt_many_times</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">((</span><span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;sample.txt&#34;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;open(2) failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">open_sample_txt_many_times</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">print_file_descriptors_by_current</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">pid_t</span> <span class="n">pid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="n">pid</span> <span class="o">=</span> <span class="nf">fork</span><span class="p">())</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;fork(2) failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;</span><span class="se">\n</span><span class="s">child process start</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">char</span> <span class="o">*</span><span class="n">child_argv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#34;./child&#34;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">        <span class="nf">execve</span><span class="p">(</span><span class="s">&#34;./child&#34;</span><span class="p">,</span> <span class="n">child_argv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nf">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;waitpid(2) failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;child process end</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">print_file_descriptors_by_current</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="nf">getpid</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">DIR</span> <span class="o">*</span><span class="n">dir</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">dirent</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="n">dir</span> <span class="o">=</span> <span class="nf">opendir</span><span class="p">(</span><span class="s">&#34;/proc/self/fd&#34;</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;opendir(3) failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">dp</span> <span class="o">=</span> <span class="nf">readdir</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span> <span class="n">dp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">dp</span> <span class="o">=</span> <span class="nf">readdir</span><span class="p">(</span><span class="n">dir</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;files[%d] =&gt; %s (in pid=%d)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>procfsには <code>/proc/[pid]/fd</code> というディレクトリが存在し，<br>
<code>pid</code> に対応するプロセスが開いているファイルディスクリプタのエントリが存在します．<br>
親プロセスではたくさんのファイルを開いておきましょう．</p>
<p>次に，子プロセスのプログラムを作ります．<br>
このプログラムでも <code>print_file_descriptors_by_current()</code> を呼び出すことで，<br>
子プロセスに親プロセスのファイルディスクリプタが引き継がれているかどうか確認します．</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;dirent.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">print_file_descriptors_by_current</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">print_file_descriptors_by_current</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">print_file_descriptors_by_current</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="nf">getpid</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">DIR</span> <span class="o">*</span><span class="n">dir</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">dirent</span> <span class="o">*</span><span class="n">dp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">((</span><span class="n">dir</span> <span class="o">=</span> <span class="nf">opendir</span><span class="p">(</span><span class="s">&#34;/proc/self/fd&#34;</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;opendir(3) failed&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">dp</span> <span class="o">=</span> <span class="nf">readdir</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span> <span class="n">dp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">dp</span> <span class="o">=</span> <span class="nf">readdir</span><span class="p">(</span><span class="n">dir</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;files[%d] =&gt; %s (in pid=%d)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">i</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>実行結果は以下のようになります．</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ gcc -o parent parent.c
</span></span><span class="line"><span class="cl">$ gcc -o child child.c
</span></span><span class="line"><span class="cl">$ ./parent
</span></span><span class="line"><span class="cl">files<span class="o">[</span>0<span class="o">]</span> <span class="o">=</span>&gt; . <span class="o">(</span>in <span class="nv">pid</span><span class="o">=</span>10636<span class="o">)</span>
</span></span><span class="line"><span class="cl">files<span class="o">[</span>1<span class="o">]</span> <span class="o">=</span>&gt; .. <span class="o">(</span>in <span class="nv">pid</span><span class="o">=</span>10636<span class="o">)</span>
</span></span><span class="line"><span class="cl">files<span class="o">[</span>2<span class="o">]</span> <span class="o">=</span>&gt; <span class="m">0</span> <span class="o">(</span>in <span class="nv">pid</span><span class="o">=</span>10636<span class="o">)</span>
</span></span><span class="line"><span class="cl">files<span class="o">[</span>3<span class="o">]</span> <span class="o">=</span>&gt; <span class="m">1</span> <span class="o">(</span>in <span class="nv">pid</span><span class="o">=</span>10636<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># stripped</span>
</span></span><span class="line"><span class="cl">files<span class="o">[</span>25<span class="o">]</span> <span class="o">=</span>&gt; <span class="m">23</span> <span class="o">(</span>in <span class="nv">pid</span><span class="o">=</span>10636<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">child process start
</span></span><span class="line"><span class="cl">files<span class="o">[</span>0<span class="o">]</span> <span class="o">=</span>&gt; . <span class="o">(</span>in <span class="nv">pid</span><span class="o">=</span>10637<span class="o">)</span>
</span></span><span class="line"><span class="cl">files<span class="o">[</span>1<span class="o">]</span> <span class="o">=</span>&gt; .. <span class="o">(</span>in <span class="nv">pid</span><span class="o">=</span>10637<span class="o">)</span>
</span></span><span class="line"><span class="cl">files<span class="o">[</span>2<span class="o">]</span> <span class="o">=</span>&gt; <span class="m">0</span> <span class="o">(</span>in <span class="nv">pid</span><span class="o">=</span>10637<span class="o">)</span>
</span></span><span class="line"><span class="cl">files<span class="o">[</span>3<span class="o">]</span> <span class="o">=</span>&gt; <span class="m">1</span> <span class="o">(</span>in <span class="nv">pid</span><span class="o">=</span>10637<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># stripped</span>
</span></span><span class="line"><span class="cl">files<span class="o">[</span>25<span class="o">]</span> <span class="o">=</span>&gt; <span class="m">23</span> <span class="o">(</span>in <span class="nv">pid</span><span class="o">=</span>10637<span class="o">)</span>
</span></span><span class="line"><span class="cl">child process end
</span></span></code></pre></div><p>それでは，<code>sample.txt</code> のopen時に <code>O_CLOEXEC</code> を渡してみます．<br>
<code>parent.c</code> の <code>open(2)</code> 呼び出し部分を変更するだけです．<br>
実行結果は以下のようになります．</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ gcc -o parent parent.c
</span></span><span class="line"><span class="cl">$ gcc -o child child.c
</span></span><span class="line"><span class="cl">$ ./parent
</span></span><span class="line"><span class="cl">files<span class="o">[</span>0<span class="o">]</span> <span class="o">=</span>&gt; . <span class="o">(</span>in <span class="nv">pid</span><span class="o">=</span>10796<span class="o">)</span>
</span></span><span class="line"><span class="cl">files<span class="o">[</span>1<span class="o">]</span> <span class="o">=</span>&gt; .. <span class="o">(</span>in <span class="nv">pid</span><span class="o">=</span>10796<span class="o">)</span>
</span></span><span class="line"><span class="cl">files<span class="o">[</span>2<span class="o">]</span> <span class="o">=</span>&gt; <span class="m">0</span> <span class="o">(</span>in <span class="nv">pid</span><span class="o">=</span>10796<span class="o">)</span>
</span></span><span class="line"><span class="cl">files<span class="o">[</span>3<span class="o">]</span> <span class="o">=</span>&gt; <span class="m">1</span> <span class="o">(</span>in <span class="nv">pid</span><span class="o">=</span>10796<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># stripped</span>
</span></span><span class="line"><span class="cl">files<span class="o">[</span>25<span class="o">]</span> <span class="o">=</span>&gt; <span class="m">23</span> <span class="o">(</span>in <span class="nv">pid</span><span class="o">=</span>10796<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">child process start
</span></span><span class="line"><span class="cl">files<span class="o">[</span>0<span class="o">]</span> <span class="o">=</span>&gt; . <span class="o">(</span>in <span class="nv">pid</span><span class="o">=</span>10797<span class="o">)</span>
</span></span><span class="line"><span class="cl">files<span class="o">[</span>1<span class="o">]</span> <span class="o">=</span>&gt; .. <span class="o">(</span>in <span class="nv">pid</span><span class="o">=</span>10797<span class="o">)</span>
</span></span><span class="line"><span class="cl">files<span class="o">[</span>2<span class="o">]</span> <span class="o">=</span>&gt; <span class="m">0</span> <span class="o">(</span>in <span class="nv">pid</span><span class="o">=</span>10797<span class="o">)</span>
</span></span><span class="line"><span class="cl">files<span class="o">[</span>3<span class="o">]</span> <span class="o">=</span>&gt; <span class="m">1</span> <span class="o">(</span>in <span class="nv">pid</span><span class="o">=</span>10797<span class="o">)</span>
</span></span><span class="line"><span class="cl">files<span class="o">[</span>4<span class="o">]</span> <span class="o">=</span>&gt; <span class="m">2</span> <span class="o">(</span>in <span class="nv">pid</span><span class="o">=</span>10797<span class="o">)</span>
</span></span><span class="line"><span class="cl">files<span class="o">[</span>5<span class="o">]</span> <span class="o">=</span>&gt; <span class="m">3</span> <span class="o">(</span>in <span class="nv">pid</span><span class="o">=</span>10797<span class="o">)</span>
</span></span><span class="line"><span class="cl">child process end
</span></span></code></pre></div><p>確かに，各 <code>open(2)</code> によって開かれたfdがコピーされていない事がわかります．</p>
<h4 id="o_creat" class="headerLink">
    <a href="#o_creat" class="header-mark"></a>1.1.3 <code>O_CREAT</code></h4><p>ファイルを新規作成する場合にこのフラグを設定します．<br>
このフラグを設定せず，存在しないファイルをオープンしようとすると <code>-1</code> が返ります．<br>
逆に <code>O_CREAT</code> を設定して既に存在するファイルをオープンした場合には問題なくopenできます．<br>
この挙動を変更したい場合， <code>O_EXCL</code> フラグを使用します(後述)．</p>
<p><code>O_CREAT</code> を利用する場合，第三引数である <code>mode</code> を渡す必要が出てきます．<br>
<code>S_IRWXU</code> などのマクロ定数を利用できますが，8進数で <code>0644</code> などとした方が使いやすい印象．</p>
<p><code>O_CREAT</code> 単体で利用するよりは， <code>O_WRONLY</code> 等と組み合わせて使う事が多いですね．</p>
<h4 id="o_directory" class="headerLink">
    <a href="#o_directory" class="header-mark"></a>1.1.4 <code>O_DIRECTORY</code></h4><p><code>pathname</code> がディレクトリでなければ失敗する，という条件を追加できるフラグです．<br>
<code>opendir(3)</code> の為に作られたものらしい．</p>
<h4 id="o_excl" class="headerLink">
    <a href="#o_excl" class="header-mark"></a>1.1.5 <code>O_EXCL</code></h4><p><code>open(2)</code> の呼び出しによってファイルが新規作成されることを保証するフラグです．<br>
これも実際に使ってみましょう．</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="s">&#34;Drumato</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;new.txt&#34;</span><span class="p">,</span> <span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">O_EXCL</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;open(2) failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>まだ存在しないファイル <code>new.txt</code> を上記フラグでopenします．<br>
このプログラムは一回目の実行は成功しますが，二回目の実行で失敗します．</p>
<h4 id="o_path" class="headerLink">
    <a href="#o_path" class="header-mark"></a>1.1.6 <code>O_PATH</code></h4><p><code>fd</code> に対する操作を制限したい場合に，<br>
具体的には，</p>
<ul>
<li>ファイルシステムツリー内の場所や存在を調べるため</li>
<li>ファイルディスクリプタレベルで動作する操作を実行するため</li>
</ul>
<p>の2つの用途に制限するフラグです．</p>
<p>ファイルディスクリプタレベルとは，<br>
<code>open/close/fstat/dup/fcntl</code> など，<br>
ファイルの中身自体にアクセスしたりしなくても使用できるAPIのことです．</p>
<h4 id="o_tmpfile" class="headerLink">
    <a href="#o_tmpfile" class="header-mark"></a>1.1.7 <code>O_TMPFILE</code></h4><p>一時ファイルを作成する為のフラグです．<br>
このフラグを設定する場合， <code>pathname</code> には &ldquo;作成する一時ファイルを含むディレクトリ&quot;を指定します．</p>
<h4 id="o_trunc" class="headerLink">
    <a href="#o_trunc" class="header-mark"></a>1.1.8 <code>O_TRUNC</code></h4><p>通常ファイル(後述)が既に存在し，書き込み許可状態でopenされているとき，<br>
ファイルの長さを0に切り詰めます．</p>
<p>実際に使ってみましょう．</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">stat</span> <span class="n">st</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="s">&#34;Drumato</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;sample.txt&#34;</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_TRUNC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;open(2) failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">fstat</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">st</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;fstat(2) failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2048</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nf">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">st</span><span class="p">.</span><span class="n">st_size</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;read(2) failed</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;read from sample.txt: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>実行結果は以下のようになります．</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">$ cat sample.txt 
</span></span><span class="line"><span class="cl">Hi! I&#39;m Drumato.
</span></span><span class="line"><span class="cl">$ gcc main.c
</span></span><span class="line"><span class="cl">$ ./a.out 
</span></span><span class="line"><span class="cl">read from sample.txt: 
</span></span><span class="line"><span class="cl">$ cat sample.txt
</span></span></code></pre></div><p>readが行われる前に，中身が切り詰められているのがわかります．<br>
<code>O_CREAT</code> によるファイルの新規作成をしたいが，既にファイルが存在する場合初期化したい際に用いられます．<br>
<code>int creat(const char *pathname, mode_t mode);</code> は <code>open(pathname, O_CREAT|O_WRONLY|O_TRUNC, mode)</code> と等しいため，<br>
<code>creat()</code> を用いる際， <code>O_TRUNC</code> が暗黙的に渡されているということですね．</p>
<h2 id="カーネルから見るopen2" class="headerLink">
    <a href="#%e3%82%ab%e3%83%bc%e3%83%8d%e3%83%ab%e3%81%8b%e3%82%89%e8%a6%8b%e3%82%8bopen2" class="header-mark"></a>2 カーネルから見るopen(2)</h2><p>ここからはLinuxカーネルの中身に入っていって，<br>
<code>open(2)</code> によってOSのどんな機能が動いているのかを理解していきましょう．<br>
対象となるLinuxカーネルは <a href="https://elixir.bootlin.com/linux/v5.10.9/source/kernel" target="_blank" rel="noopener noreferrer">v5.10.9</a> です．</p>
<h3 id="前提知識" class="headerLink">
    <a href="#%e5%89%8d%e6%8f%90%e7%9f%a5%e8%ad%98" class="header-mark"></a>2.1 前提知識</h3><p>Linuxにおいて各ユーザプロセスはファイルディスクリプタを使ってメモリ上のマッピングにアクセスします．<br>
プロセスディスクリプタを表す <code>task_struct</code> 構造体には <code>struct files_struct *files;</code> というメンバがあり，<br>
これは <strong>オープンファイルオブジェクト</strong> を管理する構造体です．<br>
オープンファイルオブジェクトはオープンファイルディスクリプタとも，<br>
ファイルハンドルとも呼ばれます．<br>
オープンファイルディスクリプタという呼称はPOSIXで用いられるようです．</p>
<p><code>dup(2)</code> 等によってファイルディスクリプタが複製されることがありますが，<br>
この場合2つのファイルディスクリプタが同じオープンファイルオブジェクトを指すことになります．</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Open file table structure
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">files_struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">   * read mostly part
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">atomic_t</span> <span class="n">count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">bool</span> <span class="n">resize_in_progress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">wait_queue_head_t</span> <span class="n">resize_wait</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">fdtable</span> <span class="n">__rcu</span> <span class="o">*</span><span class="n">fdt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">fdtable</span> <span class="n">fdtab</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">   * written part on a separate cache line in SMP
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">spinlock_t</span> <span class="n">file_lock</span> <span class="n">____cacheline_aligned_in_smp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">next_fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">close_on_exec_init</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">open_fds_init</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">full_fds_bits_init</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">file</span> <span class="n">__rcu</span> <span class="o">*</span> <span class="n">fd_array</span><span class="p">[</span><span class="n">NR_OPEN_DEFAULT</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>このうち,<code>struct fdtable *fdt</code> を用いてオープンファイルオブジェクトにアクセスします．<br>
<code>int fd</code> は単にこのテーブルのインデックスでしかありません．<br>
例えば<code>read(2)</code> では <code>struct fd f = fdget_pos(fd);</code> のようにして <code>int</code> を <code>struct fd</code> に変換していますが，<br>
最終的に <code>rcu_dereference_raw(fdt-&gt;fd[fd]);</code> という関数呼び出しの中で <code>struct fdtable.fd</code> にアクセスしています．</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">fdtable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_fds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">file</span> <span class="n">__rcu</span> <span class="o">**</span><span class="n">fd</span><span class="p">;</span>      <span class="cm">/* current fd array */</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">close_on_exec</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">open_fds</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">full_fds_bits</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">rcu_head</span> <span class="n">rcu</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p><code>struct file __rcu **fd;</code> がオープンファイルオブジェクトのテーブルです．<br>
つまり <code>struct file</code> がオープンファイルオブジェクトの実体となります．<br>
大きな構造体なので，ここでは定義の紹介はしません．<br>
先程のサンプルで <code>sample.txt</code> を20回openしたように，<br>
同じファイルを複数回オープンする事はあり得るので，<br>
一つのファイル(inode)に対して複数のオープンファイルオブジェクトが存在する可能性があります．</p>
<h3 id="大まかなコードリーディング" class="headerLink">
    <a href="#%e5%a4%a7%e3%81%be%e3%81%8b%e3%81%aa%e3%82%b3%e3%83%bc%e3%83%89%e3%83%aa%e3%83%bc%e3%83%87%e3%82%a3%e3%83%b3%e3%82%b0" class="header-mark"></a>2.2 &ldquo;大まか&quot;なコードリーディング</h3><p>それでは実際に <code>open(2)</code> の中身に入っていきます．<br>
全ての関数を深堀りするわけではなく，あくまで大まかな理解にとどめます．</p>
<h4 id="簡単なコールツリー" class="headerLink">
    <a href="#%e7%b0%a1%e5%8d%98%e3%81%aa%e3%82%b3%e3%83%bc%e3%83%ab%e3%83%84%e3%83%aa%e3%83%bc" class="header-mark"></a>2.2.1 簡単なコールツリー</h4><p>簡単にコールツリーを書き起こしておきました．<br>
私が後々本格的にコードリーディングする場合に使用するつもりで作りましたが，<br>
よかったら参考にしてください．</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl"><span class="k">-</span> <span class="sb">`sys_open`</span> ... <span class="sb">`open(2)`</span> のカーネル側エントリポイント
</span></span><span class="line"><span class="cl">  <span class="k">-</span> <span class="sb">`force_o_largefile`</span> ... プロセスの実行ドメインを検証し，必要に応じて <span class="sb">`O_LARGEFILE`</span> を設定
</span></span><span class="line"><span class="cl">  <span class="k">-</span> <span class="sb">`do_sys_open`</span> ... <span class="sb">`struct open_how`</span> の構築
</span></span><span class="line"><span class="cl">    <span class="k">-</span> <span class="sb">`do_sys_openat2`</span> ... <span class="sb">`open(2)`</span> の実体
</span></span><span class="line"><span class="cl">      <span class="k">-</span> <span class="sb">`build_open_flags`</span> ... より詳細なフラグの設定，検証
</span></span><span class="line"><span class="cl">      <span class="k">-</span> <span class="sb">`getname`</span> ... ユーザプロセス空間の`filename` を取得する
</span></span><span class="line"><span class="cl">      <span class="k">-</span> <span class="sb">`get_unused_fd_flags`</span> ... カレントプロセスが使用していないfdを探索して返す
</span></span><span class="line"><span class="cl">      <span class="k">-</span> <span class="sb">`do_filp_open`</span> ... <span class="sb">`struct file`</span> に必要な情報を突っ込んで返す
</span></span><span class="line"><span class="cl">        <span class="k">-</span> <span class="sb">`path_openat`</span> ... <span class="sb">`do_filp_open`</span> の本筋
</span></span><span class="line"><span class="cl">          <span class="k">-</span> <span class="sb">`alloc_empty_file`</span> ... <span class="sb">`kmem_cache_zalloc()`</span> で <span class="sb">`struct file`</span> を初期化
</span></span><span class="line"><span class="cl">          <span class="k">-</span> <span class="sb">`do_open`</span> ... ここまでの情報をもとにファイルを開く
</span></span><span class="line"><span class="cl">            <span class="k">-</span> <span class="sb">`vfs_open`</span> ... 仮想ファイルシステムに問い合わせ，実際にファイルを開く
</span></span><span class="line"><span class="cl">      <span class="k">-</span> <span class="sb">`fd_install`</span> ... 新しい <span class="sb">`struct file`</span> をfdtableに登録する
</span></span><span class="line"><span class="cl">      <span class="k">-</span> <span class="sb">`putname`</span> ... <span class="sb">`kmem_cache_free`</span> を呼んで <span class="sb">`struct filename`</span> を開放
</span></span></code></pre></div><h4 id="syscall_define3" class="headerLink">
    <a href="#syscall_define3" class="header-mark"></a>2.2.2 <code>SYSCALL_DEFINE3</code></h4><p>システムコールの実装を追う場合，<br>
まずは <code>SYSCALL_DEFINEN</code> マクロ関数の呼び出しを見ると良いです．<br>
例えば<code>open(2)</code> であれば，<a href="https://elixir.bootlin.com/linux/v5.10.9/source/fs/open.c#L1192" target="_blank" rel="noopener noreferrer">/fs/open.c#1192</a> にあります．</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="nf">SYSCALL_DEFINE3</span><span class="p">(</span><span class="n">open</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">umode_t</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">force_o_largefile</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="n">flags</span> <span class="o">|=</span> <span class="n">O_LARGEFILE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">do_sys_open</span><span class="p">(</span><span class="n">AT_FDCWD</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>force_o_largefile()</code> マクロは，プロセスのパーソナリティを調べます．<br>
<code>PER_LINUX32</code> フラグが立っていなければtrueが返るという処理で，<br>
恐らく32bit Linuxかどうかのチェックだと思います．</p>
<p><code>O_LARGEFILE</code> フラグについては説明していませんでしたが，<br>
ファイルサイズが32bit幅で表せず，64bit幅を必要とする場合に設定します．<br>
プロセスのパーソナリティによっては，このフラグが自動で設定されるということですね．</p>
<h4 id="do_sys_open" class="headerLink">
    <a href="#do_sys_open" class="header-mark"></a>2.2.3 <code>do_sys_open()</code></h4><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">long</span> <span class="nf">do_sys_open</span><span class="p">(</span><span class="kt">int</span> <span class="n">dfd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">umode_t</span> <span class="n">mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">open_how</span> <span class="n">how</span> <span class="o">=</span> <span class="nf">build_open_how</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nf">do_sys_openat2</span><span class="p">(</span><span class="n">dfd</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">how</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>build_open_how()</code> 関数はその名の通り，<br>
<code>open(2)</code> の挙動を制御する構造体 <code>struct open_how</code> を組み立てる関数です．<br>
組み立てたあとは <code>open(2)</code> の実体である <code>do_sys_openat2()</code> に渡して呼び出します．<br>
<code>dfd</code> には <code>AT_FDCWD</code> が渡されています．<br>
これは， <code>open(2)</code> は <code>dfd</code> に <code>AT_FDCWD</code> を指定した <code>openat(2)</code> と実質的に同じ動作をするからです．</p>
<h4 id="build_open_how" class="headerLink">
    <a href="#build_open_how" class="header-mark"></a>2.2.4 <code>build_open_how()</code></h4><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kr">inline</span> <span class="k">struct</span> <span class="n">open_how</span> <span class="nf">build_open_how</span><span class="p">(</span><span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">umode_t</span> <span class="n">mode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">open_how</span> <span class="n">how</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">VALID_OPEN_FLAGS</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span> <span class="o">&amp;</span> <span class="n">S_IALLUGO</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* O_PATH beats everything else. */</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">how</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">O_PATH</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="n">how</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="n">O_PATH_FLAGS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/* Modes should only be set for create-like flags. */</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">WILL_CREATE</span><span class="p">(</span><span class="n">how</span><span class="p">.</span><span class="n">flags</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="n">how</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">how</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>WILL_CREATE()</code> マクロによってファイルが作成されるかどうかのチェックが行われます．<br>
そうでない場合 <code>struct open_how.mode</code> は使用されません．<br>
<code>O_PATH_FLAGS</code> マクロは <code>(O_DIRECTORY | O_NOFOLLOW | O_PATH | O_CLOEXEC)</code> に展開されます．<br>
つまり， <code>O_PATH</code> フラグを渡した時点で，上記以外のフラグは全て無視されます．</p>
<h4 id="do_sys_openat2" class="headerLink">
    <a href="#do_sys_openat2" class="header-mark"></a>2.2.5 <code>do_sys_openat2()</code></h4><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">long</span> <span class="nf">do_sys_openat2</span><span class="p">(</span><span class="kt">int</span> <span class="n">dfd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			   <span class="k">struct</span> <span class="n">open_how</span> <span class="o">*</span><span class="n">how</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">open_flags</span> <span class="n">op</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nf">build_open_flags</span><span class="p">(</span><span class="n">how</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">filename</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">fd</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">tmp</span> <span class="o">=</span> <span class="nf">getname</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nf">PTR_ERR</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">fd</span> <span class="o">=</span> <span class="nf">get_unused_fd_flags</span><span class="p">(</span><span class="n">how</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="nf">do_filp_open</span><span class="p">(</span><span class="n">dfd</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">op</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nf">IS_ERR</span><span class="p">(</span><span class="n">f</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">put_unused_fd</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">fd</span> <span class="o">=</span> <span class="nf">PTR_ERR</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nf">fsnotify_open</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="nf">fd_install</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">putname</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">fd</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>build_open_flags</code> によって，詳細なフラグの検証と設定が行われます．<br>
その後 <code>get_unused_fd_flags</code> で未使用のファイルディスクリプタを探索，取得します．<br>
実際にファイルを開くのは <code>do_filp_open</code> という手続きです．</p>
<h2 id="まとめ" class="headerLink">
    <a href="#%e3%81%be%e3%81%a8%e3%82%81" class="header-mark"></a>3 まとめ</h2><p>この記事では， <code>open(2)</code> システムコールについての知識を整理しました．<br>
カーネルのコードはすべてを紹介していませんが，<br>
大まかに把握することで詳細なコードリーディングをする時の助けになると思います．</p>
<p>この調子でLinuxの勉強もがんばります．</p>
<h2 id="参考" class="headerLink">
    <a href="#%e5%8f%82%e8%80%83" class="header-mark"></a>4 参考</h2><ul>
<li><a href="https://man7.org/linux/man-pages/man2/open.2.html" target="_blank" rel="noopener noreferrer">open(2) — Linux manual page</a></li>
<li><a href="https://linuxjm.osdn.jp/html/LDP_man-pages/man2/open.2.html" target="_blank" rel="noopener noreferrer">Man page of OPEN</a></li>
<li><a href="https://wiki.bit-hive.com/linuxkernelmemo/pg/Virtual%20File%20System" target="_blank" rel="noopener noreferrer">Virtual File System</a></li>
<li><a href="https://elixir.bootlin.com/linux/v5.10.9/source" target="_blank" rel="noopener noreferrer">Linux source code (v5.10.9) - Bootlin</a></li>
</ul>
</div>

        <div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2021-01-24</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="#" onclick="return false;" title="Share on Twitter" data-sharer="twitter" data-url="http://drumato.com/ja/posts/recap-linux-open-syscall/" data-title="Linuxのopen(2) syscallをもう一度復習する" data-hashtags="c,linux"><i class="fab fa-twitter fa-fw"></i></a><a href="#" onclick="return false;" title="Share on Facebook" data-sharer="facebook" data-url="http://drumato.com/ja/posts/recap-linux-open-syscall/" data-hashtag="c"><i class="fab fa-facebook-square fa-fw"></i></a><a href="#" onclick="return false;" title="Share on Hacker News" data-sharer="hackernews" data-url="http://drumato.com/ja/posts/recap-linux-open-syscall/" data-title="Linuxのopen(2) syscallをもう一度復習する"><i class="fab fa-hacker-news fa-fw"></i></a><a href="#" onclick="return false;" title="Share on Reddit" data-sharer="reddit" data-url="http://drumato.com/ja/posts/recap-linux-open-syscall/"><i class="fab fa-reddit fa-fw"></i></a><a href="#" onclick="return false;" title="Share on Line" data-sharer="line" data-url="http://drumato.com/ja/posts/recap-linux-open-syscall/" data-title="Linuxのopen(2) syscallをもう一度復習する"><i data-svg-src="/lib/simple-icons/icons/line.min.svg"></i></a><a href="#" onclick="return false;" title="Share on Pocket" data-sharer="pocket" data-url="http://drumato.com/ja/posts/recap-linux-open-syscall/"><i class="fab fa-get-pocket fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/ja/tags/c/">c</a>,&nbsp;<a href="/ja/tags/linux/">linux</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/ja/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/ja/posts/type-system1/" class="prev" rel="prev" title="Rustでつくる単相型システムもどき"><i class="fas fa-angle-left fa-fw"></i>Rustでつくる単相型システムもどき</a>
            <a href="/ja/posts/cybozu-labs-youth-10th/" class="next" rel="next" title="Cybozu Labs Youth 10thとして一年間活動しました">Cybozu Labs Youth 10thとして一年間活動しました<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">
                    Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreferrer" title="Hugo 0.108.0">Hugo</a>&nbsp;|&nbsp;Theme - <a href="https://github.com/HEIGE-PCloud/DoIt" target="_blank" rel="noopener noreferrer" title="DoIt 0.2.13"><i class="far fa-edit fa-fw"></i> DoIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2022</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/ja/" target="_blank" rel="noopener noreferrer">Drumato</a></span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="Back to Top">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
            <i class="fas fa-comment fa-fw"></i>
        </a>
    </div><div class="assets"><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/fuse/fuse.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/topbar/topbar.min.js"></script><script type="text/javascript" src="/lib/pjax/pjax.min.js"></script><script type="text/javascript" src="/js/theme.min.js" defer></script></div>

<div class="pjax-assets"><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{},"data":{"desktop-header-typeit":"drumato.com","mobile-header-typeit":"drumato.com"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"distance":100,"findAllMatches":false,"fuseIndexURL":"/ja/index.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":false,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"No results found","snippetLength":30,"threshold":0.3,"type":"fuse","useExtendedSearch":false},"sharerjs":true,"typeit":{"cursorChar":null,"cursorSpeed":null,"data":{"desktop-header-typeit":["desktop-header-typeit"],"mobile-header-typeit":["mobile-header-typeit"]},"duration":null,"speed":null}};</script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/typeit/typeit.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js" defer></script><script type="text/javascript" src="/lib/katex/auto-render.min.js" defer></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js" defer></script><script type="text/javascript" src="/lib/katex/mhchem.min.js" defer></script><script type="text/javascript" src="/js/katex.min.js" defer></script><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/katex/copy-tex.min.css">
        <noscript><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"></noscript></div>
</body>

</html>